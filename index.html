<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CryptoTrade Pro — Working Edition (Paper Trading)</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<style>
  :root{
    --bg:#0b0b0b; --panel:#0f1113; --accent:#00ff88; --accent2:#00d4ff; --danger:#ff4444; --muted:#888;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e8eef2;font-family:Inter,system-ui,Segoe UI,Roboto,"SF Pro Display",sans-serif}
  .app{display:grid;grid-template-columns:300px 1fr 360px;grid-template-rows:70px 1fr 140px;height:100vh;gap:8px;padding:12px}
  header{grid-column:1/-1;background:linear-gradient(90deg,#0c0c0c,#111);display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-radius:8px}
  .logo{font-weight:700;font-size:20px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .status{display:flex;gap:14px;align-items:center;font-size:13px;color:var(--muted)}
  nav{background:linear-gradient(180deg,#0d0d0d,#0b0b0b);padding:14px;border-radius:8px;overflow:auto}
  main{background:linear-gradient(180deg,#070707,#0b0b0b);border-radius:8px;padding:14px;display:flex;flex-direction:column;gap:12px}
  aside{background:linear-gradient(180deg,#0d0d0d,#0a0a0a);padding:14px;border-radius:8px;overflow:auto}
  footer{grid-column:1/-1;background:linear-gradient(180deg,#0b0b0b,#0a0a0a);border-radius:8px;padding:12px;display:flex;gap:12px;align-items:center}
  .panel{background:var(--panel);border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  .small{font-size:12px;color:var(--muted)}
  #tradingChart{height:360px;width:100%}
  .pair{display:flex;gap:12px;align-items:baseline}
  .pair .symbol{font-size:22px;font-weight:700}
  .price{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:20px}
  .positive{color:var(--accent)} .negative{color:var(--danger)}
  .orderbook{max-height:360px;overflow:auto;font-family:ui-monospace,monospace}
  .book-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .book-row.ask{color:rgba(255,100,100,0.95)} .book-row.bid{color:rgba(0,255,136,0.95)}
  .trade-log{max-height:200px;overflow:auto;font-family:ui-monospace,monospace;background:linear-gradient(180deg,#080808,#0a0a0a);padding:8px;border-radius:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type=number],select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  button{padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn-buy{background:linear-gradient(90deg,var(--accent),#00b86a);color:#06120a}
  .btn-sell{background:linear-gradient(90deg,var(--danger),#cc0000);color:#fff}
  .stats{display:flex;gap:12px}
  .stat{background:var(--glass);padding:8px;border-radius:6px;min-width:120px;text-align:center}
  .muted{color:var(--muted)}
  .indicator{display:flex;gap:12px;align-items:center}
  .label-row{display:flex;justify-content:space-between;align-items:center}
  .alerts{position:fixed;right:18px;top:90px;width:360px;z-index:9999}
  .alert{padding:12px;border-radius:8px;margin-bottom:8px}
  .alert.success{background:linear-gradient(90deg,rgba(0,255,136,0.12),rgba(0,212,255,0.06));border:1px solid rgba(0,255,136,0.06)}
  .alert.error{background:linear-gradient(90deg,rgba(255,68,68,0.12),rgba(0,0,0,0.06));border:1px solid rgba(255,68,68,0.06)}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">CryptoTrade Pro — Working</div>
      <div class="status">
        <div id="wsStatus">WS: <span class="muted">connecting…</span></div>
        <div id="connCount">Exchanges: 0</div>
        <div id="systemTime" class="muted"></div>
      </div>
    </header>

    <nav>
      <div style="margin-bottom:12px">
        <div class="pair">
          <div>
            <div class="symbol">BTC / USDT</div>
            <div class="small muted">Live Price</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div id="currentPrice" class="price">—</div>
            <div id="priceChange" class="small muted">—</div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="label-row"><div class="small muted">Balances (paper)</div><button id="resetBalances" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:6px">Reset</button></div>
        <div class="stats" style="margin-top:12px">
          <div class="stat"><div class="small muted">Cash</div><div id="balanceCash" style="font-weight:700">$100,000.00</div></div>
          <div class="stat"><div class="small muted">BTC</div><div id="balanceBTC" style="font-weight:700">0.0000</div></div>
          <div class="stat"><div class="small muted">PnL</div><div id="balancePnL" style="font-weight:700">$0.00</div></div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div class="small muted">Order Book (aggregated)</div>
        <div class="orderbook" id="orderBook" style="margin-top:8px"></div>
      </div>

      <div class="panel">
        <div class="small muted">Recent trades (live)</div>
        <div class="trade-log" id="tradeLog"></div>
      </div>
    </nav>

    <main>
      <div class="panel">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small muted">Real-time Price Chart</div>
              <div class="small muted">Timeframe: <select id="timeframeSelect"><option value="1m">1m</option><option value="5m">5m</option></select></div>
            </div>
            <canvas id="tradingChart"></canvas>
          </div>
        </div>
      </div>

      <div class="panel" style="display:flex;gap:12px;align-items:flex-start">
        <div style="flex:1">
          <div class="small muted">Indicators</div>
          <div style="display:flex;gap:12px;margin-top:8px">
            <div style="flex:1" class="indicator"><div><div class="small muted">SMA (20)</div><div id="sma20" style="font-weight:700">—</div></div></div>
            <div style="flex:1" class="indicator"><div><div class="small muted">EMA (12)</div><div id="ema12" style="font-weight:700">—</div></div></div>
            <div style="flex:1" class="indicator"><div><div class="small muted">RSI (14)</div><div id="rsi14" style="font-weight:700">—</div></div></div>
          </div>
        </div>

        <aside style="width:360px">
          <div class="small muted">Place Paper Orders</div>
          <div style="margin-top:8px">
            <div style="margin-bottom:8px">
              <label>Order Type</label>
              <select id="orderType"><option value="market">Market</option><option value="limit">Limit</option></select>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div>
                <label>Price (USDT)</label>
                <input id="orderPrice" type="number" step="0.01" />
              </div>
              <div>
                <label>Amount (BTC)</label>
                <input id="orderAmount" type="number" step="0.00001" />
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="btnBuy" class="btn-buy">Buy (paper)</button>
              <button id="btnSell" class="btn-sell">Sell (paper)</button>
            </div>
          </div>
          <div style="margin-top:14px">
            <div class="small muted">Open Orders (paper)</div>
            <div id="openOrders" style="margin-top:8px"></div>
          </div>
        </aside>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small muted">Order / Execution Log</div>
          <div class="small muted">Simulated execution only</div>
        </div>
        <div id="executionLog" style="margin-top:8px;max-height:160px;overflow:auto;font-family:ui-monospace,monospace;padding:8px;background:linear-gradient(180deg,#060606,#080808);border-radius:6px"></div>
      </div>
    </main>

    <aside>
      <div class="panel">
        <div class="small muted">System</div>
        <div style="margin-top:10px">
          <div id="connectionInfo" class="small muted">Binance WS: connecting...</div>
          <div style="margin-top:8px" id="debugInfo" class="small muted"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="small muted">Notes</div>
        <div class="small muted" style="margin-top:8px">This app is paper-trading only. Do NOT put real API keys here. To enable real trading you must implement a secure backend and server-side order signing.</div>
      </div>
    </aside>

    <footer>
      <div class="small muted">Local test — live Binance public streams. No private keys used.</div>
    </footer>
  </div>

  <div class="alerts" id="alerts"></div>

<script>
/*
  Fully working front-end application (paper trading).
  - Connects to Binance public websockets
  - Live price/trades/depth
  - Chart with SMA overlay
  - SMA, EMA, RSI calculations
  - Paper trading engine with balances & order history
*/

// -------------------- Utility helpers --------------------
function formatUSD(v){ return typeof v === 'number' ? v.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}) : v; }
function smallNum(n){ return Number(n).toFixed(6); }
function addAlert(msg,type='success',timeout=5000){
  const hub = document.getElementById('alerts');
  const el = document.createElement('div'); el.className = `alert ${type}`; el.textContent = msg; hub.appendChild(el);
  setTimeout(()=> el.remove(), timeout);
}

// -------------------- Simple indicator functions --------------------
function sma(arr,period){
  if(!arr || arr.length < period) return null;
  const slice = arr.slice(-period);
  const sum = slice.reduce((s,v)=>s+v,0);
  return sum/period;
}
function ema(arr,period){
  if(!arr || arr.length === 0) return null;
  const alpha = 2/(period+1);
  let prev = arr[0];
  for(let i=1;i<arr.length;i++){
    prev = alpha*arr[i] + (1-alpha)*prev;
  }
  return prev;
}
function rsi(arr,period=14){
  if(!arr || arr.length < period+1) return null;
  let gains=0,losses=0;
  for(let i=arr.length-period;i<arr.length;i++){
    const delta = arr[i] - arr[i-1];
    if(delta>0) gains+=delta; else losses+=Math.abs(delta);
  }
  const avgGain = gains/period;
  const avgLoss = losses/period;
  if(avgLoss === 0) return 100;
  const rs = avgGain/avgLoss;
  return 100 - (100/(1+rs));
}

// -------------------- App state --------------------
const App = {
  ws: null,
  wsDepth: null,
  priceHistory: [], // {ts, price}
  tradeHistory: [], // recent trades (from ws)
  aggregatedOrderBook: { bids: [], asks: [] }, // aggregated top levels
  cash: 100000, // USD paper
  btc: 0,
  openOrders: [], // limit orders simulated
  executedOrders: [],
  chart: null,
  chartConfig: null,
  lastPrice: null,
  sma20: null,
  ema12: null,
  rsi14: null,
  isConnected: false,
};

// -------------------- UI elements --------------------
const el = {
  currentPrice: document.getElementById('currentPrice'),
  priceChange: document.getElementById('priceChange'),
  tradeLog: document.getElementById('tradeLog'),
  orderBook: document.getElementById('orderBook'),
  balanceCash: document.getElementById('balanceCash'),
  balanceBTC: document.getElementById('balanceBTC'),
  balancePnL: document.getElementById('balancePnL'),
  sma20: document.getElementById('sma20'),
  ema12: document.getElementById('ema12'),
  rsi14: document.getElementById('rsi14'),
  executionLog: document.getElementById('executionLog'),
  openOrders: document.getElementById('openOrders'),
  wsStatus: document.getElementById('wsStatus'),
  connectionInfo: document.getElementById('connectionInfo'),
  debugInfo: document.getElementById('debugInfo'),
  systemTime: document.getElementById('systemTime'),
};

// -------------------- Chart setup --------------------
function initChart(){
  const ctx = document.getElementById('tradingChart').getContext('2d');

  App.chartConfig = {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label:'Price', data:[], borderColor:'#00ff88', borderWidth:2, pointRadius:0, tension:0.15 },
        { label:'SMA20', data:[], borderColor:'#00d4ff', borderWidth:1.5, pointRadius:0, borderDash: [6,4], tension:0.3 }
      ]
    },
    options: {
      animation:false,
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{display:true,grid:{display:false}},
        y:{display:true,grid:{color:'rgba(255,255,255,0.03)'}}
      }
    }
  };

  App.chart = new Chart(ctx, App.chartConfig);
}

// -------------------- WebSocket connections --------------------
function connectWS(){
  try{
    // trades stream
    const tradeUrl = 'wss://stream.binance.com:9443/ws/btcusdt@trade';
    const depthUrl = 'wss://stream.binance.com:9443/ws/btcusdt@depth@100ms';

    App.ws = new WebSocket(tradeUrl);
    App.ws.onopen = ()=> {
      App.isConnected = true;
      el.wsStatus.textContent = 'WS: connected';
      el.connectionInfo.textContent = 'Connected to Binance public WS (trade stream)';
      addAlert('Connected to Binance trade stream', 'success', 3000);
    };
    App.ws.onmessage = (evt)=> {
      try{
        const d = JSON.parse(evt.data);
        // {p: "price", q: "qty", T: timestamp, m: isBuyerMaker}
        const price = parseFloat(d.p);
        const ts = d.T;
        handleTrade({price, qty:parseFloat(d.q), side: d.m ? 'sell' : 'buy', ts});
      } catch(e){
        console.error('trade parse',e);
      }
    };
    App.ws.onerror = (err)=> {
      console.error('trade ws error', err);
      el.wsStatus.textContent = 'WS: error';
      el.connectionInfo.textContent = 'Trade WS error: see console';
      addAlert('Trade WS error', 'error', 5000);
    };
    App.ws.onclose = ()=> {
      App.isConnected = false;
      el.wsStatus.textContent = 'WS: closed';
      el.connectionInfo.textContent = 'Trade WS closed';
      addAlert('Trade WS closed', 'error', 5000);
      // auto-reconnect after short delay
      setTimeout(connectWS, 3000);
    };

    // depth stream (order book)
    App.wsDepth = new WebSocket(depthUrl);
    App.wsDepth.onopen = ()=> {
      el.debugInfo.textContent = 'Depth stream connected';
    };
    App.wsDepth.onmessage = (evt)=>{
      try{
        const d = JSON.parse(evt.data);
        // d: {b:[ [price, qty], ...], a:[...] }
        const bids = (d.b || []).map(x => [parseFloat(x[0]), parseFloat(x[1])]);
        const asks = (d.a || []).map(x => [parseFloat(x[0]), parseFloat(x[1])]);
        handleDepth({bids, asks});
      }catch(e){
        console.error('depth parse',e);
      }
    };
    App.wsDepth.onerror = ()=> {
      el.debugInfo.textContent = 'Depth WS error';
    };
    App.wsDepth.onclose = ()=> {
      el.debugInfo.textContent = 'Depth WS closed - reconnecting';
      setTimeout(()=> {
        connectWS(); // reconnect both
      }, 3000);
    };

  }catch(err){
    console.error('connectWS',err);
  }
}

// -------------------- Handlers --------------------
function handleTrade(tr){
  // maintain last N trades
  App.lastPrice = tr.price;
  App.tradeHistory.unshift(tr);
  if(App.tradeHistory.length > 200) App.tradeHistory.pop();

  // add to price history as OHLC is not available from single trade; we treat last-trade as price point
  App.priceHistory.push({ts: tr.ts, price: tr.price});
  if(App.priceHistory.length > 500) App.priceHistory.shift();

  // update UI
  updateTradeLog(tr);
  updatePriceUI(tr.price);
  updateIndicatorsAndChart();
  processOpenOrders(tr.price); // execute limit orders if price crosses
}

function handleDepth(book){
  // Keep top 10 per side aggregated
  App.aggregatedOrderBook.bids = (book.bids || []).slice(0,12);
  App.aggregatedOrderBook.asks = (book.asks || []).slice(0,12);
  renderOrderBook();
}

// -------------------- UI update functions --------------------
function updateTradeLog(tr){
  try{
    const elT = document.createElement('div');
    elT.style.padding = '6px 4px';
    elT.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
    elT.style.fontSize = '12px';
    elT.textContent = `${new Date(tr.ts).toLocaleTimeString()} ${tr.side.toUpperCase()} ${tr.price.toFixed(2)} x ${tr.qty}`;
    const container = el.tradeLog;
    container.prepend(elT);
    if(container.childNodes.length > 200) container.removeChild(container.lastChild);
  }catch(e){console.error(e)}
}

function updatePriceUI(price){
  el.currentPrice.textContent = price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  // change since previous price
  const prev = App.priceHistory.length > 1 ? App.priceHistory[App.priceHistory.length-2].price : price;
  const diff = price - prev;
  const pct = prev ? (diff/prev*100) : 0;
  el.priceChange.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
  el.priceChange.className = pct>=0? 'small positive':'small negative';
}

function renderOrderBook(){
  try{
    const container = el.orderBook;
    container.innerHTML = '';
    // show top asks (reverse so best ask at top)
    const asks = App.aggregatedOrderBook.asks.slice(0,10);
    asks.forEach(a=>{
      const div = document.createElement('div'); div.className='book-row ask'; div.innerHTML = `<div>${a[0].toFixed(2)}</div><div style="text-align:right">${a[1].toFixed(6)}</div>`; container.appendChild(div);
    });
    // separator
    const sep = document.createElement('div'); sep.style.textAlign='center'; sep.style.padding='6px'; sep.style.color='var(--muted)'; sep.textContent='--- best ---'; container.appendChild(sep);
    // bids
    const bids = App.aggregatedOrderBook.bids.slice(0,10);
    bids.forEach(b=>{
      const div = document.createElement('div'); div.className='book-row bid'; div.innerHTML = `<div>${b[0].toFixed(2)}</div><div style="text-align:right">${b[1].toFixed(6)}</div>`; container.appendChild(div);
    });
  }catch(e){console.error(e)}
}

// -------------------- Indicators & Chart update --------------------
function updateIndicatorsAndChart(){
  try{
    const prices = App.priceHistory.map(p => p.price);
    // SMA20
    const s20 = sma(prices, 20);
    App.sma20 = s20;
    el.sma20.textContent = s20 ? s20.toFixed(2) : '—';
    // EMA12
    const e12 = ema(prices, 12);
    App.ema12 = e12;
    el.ema12.textContent = e12 ? e12.toFixed(2) : '—';
    // RSI14
    const r14 = rsi(prices, 14);
    App.rsi14 = r14;
    el.rsi14.textContent = r14 ? r14.toFixed(2) : '—';

    // update chart dataset
    if(App.chart){
      const labels = App.priceHistory.map(p => new Date(p.ts).toLocaleTimeString());
      const dataset = App.priceHistory.map(p => p.price);
      App.chart.data.labels = labels.slice(-200);
      App.chart.data.datasets[0].data = dataset.slice(-200);
      // compute sma series for overlay
      const smaSeries = [];
      for(let i=0;i<App.priceHistory.length;i++){
        const sub = App.priceHistory.slice(0,i+1).map(x=>x.price);
        const val = sma(sub,20);
        smaSeries.push(val || null);
      }
      App.chart.data.datasets[1].data = smaSeries.slice(-200);
      App.chart.update('none');
    }
  }catch(e){
    console.error('updateIndicators',e);
  }
}

// -------------------- Paper trading engine --------------------
function placePaperOrder(side, type, price, amount){
  try{
    if(amount <= 0) { addAlert('Amount must be > 0', 'error'); return; }
    if(type === 'market'){
      // execute immediately against lastPrice
      if(!App.lastPrice){ addAlert('No market price available', 'error'); return; }
      const execPrice = App.lastPrice;
      executeTrade({side, price: execPrice, amount});
      addAlert(`${side.toUpperCase()} market executed @ ${execPrice.toFixed(2)}`, 'success');
      return;
    } else {
      // limit - add to openOrders
      const id = 'o' + Date.now() + Math.floor(Math.random()*999);
      const order = {id, side, type:'limit', price: parseFloat(price), amount: parseFloat(amount), ts: Date.now()};
      App.openOrders.push(order);
      renderOpenOrders();
      addAlert(`${side} limit placed ${price} x ${amount}`, 'success');
    }
  }catch(e){
    console.error('placePaperOrder',e);
  }
}

function renderOpenOrders(){
  try{
    const container = el.openOrders;
    container.innerHTML = '';
    if(App.openOrders.length === 0) { container.innerHTML = '<div class="small muted">No open orders</div>'; return; }
    App.openOrders.forEach(o=>{
      const d = document.createElement('div');
      d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)'; d.style.display='flex'; d.style.justifyContent='space-between';
      d.innerHTML = `<div style="font-size:13px">${o.side.toUpperCase()} ${o.amount} @ ${o.price.toFixed(2)}</div><div><button data-id="${o.id}" style="background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:6px">Cancel</button></div>`;
      container.appendChild(d);
      d.querySelector('button').onclick = ()=> { cancelOpenOrder(o.id); };
    });
  }catch(e){console.error(e)}
}

function cancelOpenOrder(id){
  App.openOrders = App.openOrders.filter(o=>o.id !== id);
  renderOpenOrders();
  addAlert('Order cancelled', 'success');
}

function processOpenOrders(currentPrice){
  // Execute limit orders if price crosses limit (simple logic)
  const remaining = [];
  App.openOrders.forEach(o=>{
    if(o.side === 'buy'){
      if(currentPrice <= o.price){
        executeTrade({side:'buy', price:o.price, amount:o.amount, fromLimit:true});
        addAlert(`Limit BUY executed @ ${o.price.toFixed(2)}`, 'success');
      } else remaining.push(o);
    } else {
      if(currentPrice >= o.price){
        executeTrade({side:'sell', price:o.price, amount:o.amount, fromLimit:true});
        addAlert(`Limit SELL executed @ ${o.price.toFixed(2)}`, 'success');
      } else remaining.push(o);
    }
  });
  App.openOrders = remaining;
  renderOpenOrders();
}

function executeTrade({side, price, amount, fromLimit=false}){
  try{
    const cost = price * amount;
    if(side === 'buy'){
      if(App.cash < cost){ addAlert('Insufficient cash', 'error'); return false; }
      App.cash -= cost;
      App.btc += amount;
    } else {
      if(App.btc < amount){ addAlert('Insufficient BTC', 'error'); return false; }
      App.btc -= amount;
      App.cash += cost;
    }
    const record = {side, price, amount, ts: Date.now(), fromLimit};
    App.executedOrders.push(record);
    if(App.executedOrders.length > 500) App.executedOrders.shift();
    // update UI balances
    renderBalances();
    appendExecutionLog(record);
    return true;
  }catch(e){console.error('executeTrade',e); return false}
}

function appendExecutionLog(rec){
  const eln = document.createElement('div');
  eln.style.padding = '6px 4px'; eln.style.borderBottom='1px solid rgba(255,255,255,0.02)';
  eln.textContent = `${new Date(rec.ts).toLocaleTimeString()} ${rec.side.toUpperCase()} ${rec.amount} @ ${rec.price.toFixed(2)}`;
  el.executionLog.prepend(eln);
  if(el.executionLog.childNodes.length > 500) el.executionLog.removeChild(el.executionLog.lastChild);
}

// -------------------- Balances --------------------
function renderBalances(){
  el.balanceCash.textContent = formatUSD(App.cash);
  el.balanceBTC.textContent = smallNum(App.btc);
  const mark = App.lastPrice || 0;
  const net = App.cash + App.btc * mark;
  const pnl = net - 100000;
  el.balancePnL.textContent = formatUSD(pnl);
}

// -------------------- UI event wiring --------------------
document.getElementById('btnBuy').addEventListener('click', ()=> {
  const type = document.getElementById('orderType').value;
  const price = parseFloat(document.getElementById('orderPrice').value);
  const amount = parseFloat(document.getElementById('orderAmount').value);
  placePaperOrder('buy', type, price, amount);
});
document.getElementById('btnSell').addEventListener('click', ()=> {
  const type = document.getElementById('orderType').value;
  const price = parseFloat(document.getElementById('orderPrice').value);
  const amount = parseFloat(document.getElementById('orderAmount').value);
  placePaperOrder('sell', type, price, amount);
});
document.getElementById('resetBalances').addEventListener('click', ()=>{
  App.cash = 100000; App.btc = 0; App.openOrders = []; App.executedOrders = []; renderBalances(); renderOpenOrders(); addAlert('Balances reset', 'success');
});

// -------------------- Initialize --------------------
function start(){
  try{
    initChart();
    renderBalances();
    renderOpenOrders();
    connectWS();
    // heartbeat UI
    setInterval(()=> {
      const now = new Date(); el.systemTime.textContent = now.toLocaleTimeString();
    },1000);
  }catch(e){
    console.error('start',e);
  }
}

start();

</script>
</body>
</html>
