<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Assistant</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        #app-container {
            max-width: 1200px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #00bfa5;
        }
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls label {
            font-weight: bold;
        }
        #symbol-search {
            padding: 8px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            width: 250px;
        }
        #chart-container {
            width: 100%;
            height: 600px;
            border: 1px solid #444;
            border-radius: 4px;
        }
        #info-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #444;
        }
        #info-panel h2 {
            margin-top: 0;
            color: #00bfa5;
        }
        #signals-list {
            list-style-type: none;
            padding: 0;
        }
        #signals-list li {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
        .signal-bullish { color: #26a69a; }
        .signal-bearish { color: #ef5350; }
        .loader {
            text-align: center;
            font-size: 1.2em;
        }
    </style>
</head>
<body>

<div id="app-container">
    <h1>Client-Side Crypto Trading Assistant</h1>

    <div class="controls">
        <label for="symbol-search">Select Trading Pair:</label>
        <select id="symbol-search"></select>
        
        <label for="timeframe-select">Timeframe:</label>
        <select id="timeframe-select">
            <option value="1h" selected>1 Hour</option>
            <option value="4h">4 Hours</option>
            <option value="1d">1 Day</option>
            <option value="1w">1 Week</option>
        </select>
    </div>

    <div id="chart-container"></div>
    
    <div id="info-panel">
        <h2>Analysis & Signals</h2>
        <div id="analysis-content" class="loader">Select a pair to begin analysis...</div>
    </div>
</div>

<script>
    // Destructure necessary libraries from the window object
    const { createChart } = LightweightCharts;
    const { SMA, RSI, MACD, BollingerBands } = technicalindicators;

    // DOM Elements
    const chartContainer = document.getElementById('chart-container');
    const symbolSearch = document.getElementById('symbol-search');
    const timeframeSelect = document.getElementById('timeframe-select');
    const analysisContent = document.getElementById('analysis-content');

    // Chart instance
    let chart;
    let candlestickSeries;
    
    // --- Chart Setup ---
    function initializeChart() {
        if (chart) {
            chart.remove();
        }
        chart = createChart(chartContainer, {
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight,
            layout: {
                backgroundColor: '#121212',
                textColor: '#e0e0e0',
            },
            grid: {
                vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
            },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            timeScale: { timeVisible: true, secondsVisible: false },
        });
        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderDownColor: '#ef5350',
            borderUpColor: '#26a69a',
            wickDownColor: '#ef5350',
            wickUpColor: '#26a69a',
        });
    }

    // --- Data Fetching ---
    async function fetchBinanceSymbols() {
        try {
            // We use a proxy to avoid CORS issues if running locally.
            // On GitHub Pages, direct calls might work but a proxy is more robust.
            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const apiUrl = 'https://api.binance.com/api/v3/exchangeInfo';
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            const data = await response.json();
            const exchangeInfo = JSON.parse(data.contents);
            
            const usdtPairs = exchangeInfo.symbols
                .filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING')
                .map(s => s.symbol);

            symbolSearch.innerHTML = usdtPairs.map(symbol => `<option value="${symbol}">${symbol}</option>`).join('');
            
            // Load initial chart for the first symbol
            loadChartData(usdtPairs[0], timeframeSelect.value);

        } catch (error) {
            console.error('Error fetching Binance symbols:', error);
            analysisContent.innerHTML = 'Failed to load symbol list from Binance.';
        }
    }

    async function fetchChartData(symbol, timeframe) {
        try {
            analysisContent.innerHTML = `<div class="loader">Loading ${symbol} data...</div>`;
            const limit = 500;
            // Using the same proxy for candlestick data
            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const apiUrl = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${timeframe}&limit=${limit}`;
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            const data = await response.json();
            const klines = JSON.parse(data.contents);

            const chartData = klines.map(k => ({
                time: k[0] / 1000, // Binance provides timestamp in ms, chart needs seconds
                open: parseFloat(k[1]),
                high: parseFloat(k[2]),
                low: parseFloat(k[3]),
                close: parseFloat(k[4]),
            }));

            return chartData;
        } catch (error) {
            console.error(`Error fetching chart data for ${symbol}:`, error);
            analysisContent.innerHTML = `Failed to load chart data for ${symbol}. Check console for errors.`;
            return [];
        }
    }

    // --- Indicator Calculation & Plotting ---
    function processDataAndPlot(data) {
        if (!data || data.length === 0) return;

        candlestickSeries.setData(data);

        // Calculate indicators
        const closePrices = data.map(d => d.close);
        
        // SMA 50 & 200
        const sma50 = SMA.calculate({ period: 50, values: closePrices });
        const sma200 = SMA.calculate({ period: 200, values: closePrices });

        // RSI
        const rsi = RSI.calculate({ period: 14, values: closePrices });
        
        // MACD
        const macdInput = {
            values: closePrices,
            fastPeriod: 12,
            slowPeriod: 26,
            signalPeriod: 9,
            SimpleMAOscillator: false,
            SimpleMASignal: false
        };
        const macd = MACD.calculate(macdInput);
        
        // Plot SMAs
        plotLineSeries(sma50, data, 50, '#e91e63', 'SMA 50');
        plotLineSeries(sma200, data, 200, '#2196f3', 'SMA 200');

        // Analyze and generate signals
        generateSignals(data, sma50, sma200, rsi, macd);
        
        chart.timeScale().fitContent();
    }

    function plotLineSeries(indicatorData, chartData, period, color, title) {
        const lineData = indicatorData.map((value, index) => ({
            time: chartData[index + period - 1].time,
            value: value,
        }));
        const lineSeries = chart.addLineSeries({ color, lineWidth: 2, title });
        lineSeries.setData(lineData);
    }
    
    function generateSignals(chartData, sma50, sma200, rsi, macd) {
        let signalsHTML = '<h3>Potential Setups:</h3><ul id="signals-list">';
        const markers = [];

        // --- 1. Golden Cross / Death Cross ---
        const latestSma50 = sma50[sma50.length - 1];
        const prevSma50 = sma50[sma50.length - 2];
        const latestSma200 = sma200[sma200.length - (200 - 50) -1];
        const prevSma200 = sma200[sma200.length - (200 - 50) - 2];

        if (prevSma50 < prevSma200 && latestSma50 > latestSma200) {
            signalsHTML += `<li class="signal-bullish">üìà Golden Cross (SMA50 crossed above SMA200) - Potential Bullish Trend</li>`;
            markers.push({ time: chartData[chartData.length - 1].time, position: 'belowBar', color: '#26a69a', shape: 'arrowUp', text: 'Golden Cross' });
        }
        if (prevSma50 > prevSma200 && latestSma50 < latestSma200) {
            signalsHTML += `<li class="signal-bearish">üìâ Death Cross (SMA50 crossed below SMA200) - Potential Bearish Trend</li>`;
             markers.push({ time: chartData[chartData.length - 1].time, position: 'aboveBar', color: '#ef5350', shape: 'arrowDown', text: 'Death Cross' });
        }

        // --- 2. RSI Overbought / Oversold ---
        const latestRsi = rsi[rsi.length - 1];
        if (latestRsi > 70) {
            signalsHTML += `<li class="signal-bearish">‚ö†Ô∏è RSI Overbought (${latestRsi.toFixed(2)}) - Market may be due for a pullback.</li>`;
        }
        if (latestRsi < 30) {
            signalsHTML += `<li class="signal-bullish">‚úÖ RSI Oversold (${latestRsi.toFixed(2)}) - Market may be due for a bounce.</li>`;
        }

        // --- 3. MACD Crossover ---
        const latestMacd = macd[macd.length - 1];
        const prevMacd = macd[macd.length - 2];
        if (prevMacd.MACD < prevMacd.signal && latestMacd.MACD > latestMacd.signal) {
             signalsHTML += `<li class="signal-bullish">üîµ MACD Bullish Crossover - Potential upward momentum.</li>`;
             markers.push({ time: chartData[chartData.length - 1].time, position: 'belowBar', color: '#2196f3', shape: 'arrowUp', text: 'MACD Cross' });
        }
        if (prevMacd.MACD > prevMacd.signal && latestMacd.MACD < latestMacd.signal) {
             signalsHTML += `<li class="signal-bearish">üî¥ MACD Bearish Crossover - Potential downward momentum.</li>`;
             markers.push({ time: chartData[chartData.length - 1].time, position: 'aboveBar', color: '#ff9800', shape: 'arrowDown', text: 'MACD Cross' });
        }

        if (signalsHTML === '<h3>Potential Setups:</h3><ul id="signals-list">') {
            signalsHTML += '<li>No strong signals detected based on current indicators.</li>';
        }

        signalsHTML += '</ul>';
        analysisContent.innerHTML = signalsHTML;
        candlestickSeries.setMarkers(markers);
    }

    // --- Main Application Logic ---
    async function loadChartData(symbol, timeframe) {
        initializeChart();
        const data = await fetchChartData(symbol, timeframe);
        processDataAndPlot(data);
    }
    
    // --- Event Listeners ---
    symbolSearch.addEventListener('change', (e) => {
        loadChartData(e.target.value, timeframeSelect.value);
    });

    timeframeSelect.addEventListener('change', (e) => {
        loadChartData(symbolSearch.value, e.target.value);
    });

    window.addEventListener('resize', () => {
        if (chart) {
            chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
        }
    });

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchBinanceSymbols();
    });

</script>
</body>
</html>
