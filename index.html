<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Crypto Trading System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-tertiary: #1e2340;
            --accent-green: #00ff88;
            --accent-red: #ff4757;
            --accent-blue: #4c6ef5;
            --accent-yellow: #ffd93d;
            --text-primary: #ffffff;
            --text-secondary: #8b92b8;
            --border-color: #2d3561;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-title {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        select, input {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
        }

        select:focus, input:focus {
            border-color: var(--accent-blue);
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 110, 245, 0.4);
        }

        button.success {
            background: var(--accent-green);
        }

        button.danger {
            background: var(--accent-red);
        }

        /* Main Grid Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Price Card */
        .price-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .price-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .price-info h2 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .price-value {
            font-size: 42px;
            font-weight: bold;
            color: var(--accent-green);
        }

        .price-value.negative {
            color: var(--accent-red);
        }

        .price-change {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .change-24h {
            font-size: 24px;
            font-weight: bold;
        }

        .change-percent {
            font-size: 16px;
            opacity: 0.8;
        }

        /* Signal Strength */
        .signal-strength {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .signal-value {
            font-size: 32px;
            font-weight: bold;
        }

        .signal-bar {
            height: 30px;
            background: var(--bg-primary);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .signal-fill {
            height: 100%;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .signal-fill.bullish {
            background: linear-gradient(90deg, var(--accent-green), #00cc66);
        }

        .signal-fill.bearish {
            background: linear-gradient(90deg, var(--accent-red), #cc0033);
        }

        .signal-fill.neutral {
            background: linear-gradient(90deg, var(--accent-yellow), #ffaa00);
        }

        /* Indicators Grid */
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .indicator-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .indicator-card.bullish {
            border-left-color: var(--accent-green);
        }

        .indicator-card.bearish {
            border-left-color: var(--accent-red);
        }

        .indicator-name {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .indicator-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .indicator-signal {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .indicator-signal.buy {
            color: var(--accent-green);
        }

        .indicator-signal.sell {
            color: var(--accent-red);
        }

        .indicator-signal.neutral {
            color: var(--accent-yellow);
        }

        /* Trade Setup */
        .trade-setup {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .setup-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--accent-green);
        }

        .setup-section {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .setup-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .setup-values {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setup-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setup-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .setup-value {
            font-size: 16px;
            font-weight: 600;
        }

        .setup-value.green {
            color: var(--accent-green);
        }

        .setup-value.red {
            color: var(--accent-red);
        }

        .setup-value.blue {
            color: var(--accent-blue);
        }

        /* ML Prediction */
        .ml-prediction {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .ml-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ml-title {
            font-size: 16px;
            font-weight: bold;
        }

        .ml-confidence {
            font-size: 14px;
            opacity: 0.9;
        }

        .ml-predictions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ml-prediction-row {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .ml-timeframe {
            font-size: 14px;
            opacity: 0.9;
        }

        .ml-price {
            font-size: 16px;
            font-weight: bold;
        }

        /* Bottom Grid */
        .bottom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-blue);
        }

        /* Market Conditions */
        .market-condition {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .condition-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .condition-value {
            font-size: 16px;
            font-weight: 600;
        }

        /* Multi-timeframe */
        .timeframe-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .timeframe-card {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .timeframe-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .timeframe-signal {
            font-size: 16px;
            font-weight: bold;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            position: relative;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--accent-blue);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Risk Meter */
        .risk-meter {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .risk-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-primary);
            border-radius: 2px;
        }

        .risk-bar.active {
            background: var(--accent-green);
        }

        .risk-bar.active.medium {
            background: var(--accent-yellow);
        }

        .risk-bar.active.high {
            background: var(--accent-red);
        }

        /* File Upload */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: var(--bg-tertiary);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--accent-green);
        }

        .notification.error {
            border-left: 4px solid var(--accent-red);
        }

        .notification.info {
            border-left: 4px solid var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1 class="header-title">üöÄ Advanced Crypto Trading System</h1>
                <div class="connection-status">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Symbol:</label>
                    <select id="symbolSelect">
                        <option value="WIFUSDT">WIF/USDT</option>
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="ADAUSDT">ADA/USDT</option>
                        <option value="DOGEUSDT">DOGE/USDT</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Timeframe:</label>
                    <select id="timeframeSelect">
                        <option value="1m">1 Minute</option>
                        <option value="5m">5 Minutes</option>
                        <option value="15m" selected>15 Minutes</option>
                        <option value="1h">1 Hour</option>
                        <option value="4h">4 Hours</option>
                        <option value="1d">1 Day</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Account Size:</label>
                    <input type="number" id="accountSize" value="1000" min="100" step="100" placeholder="USDT">
                </div>
                <div class="control-group">
                    <label>Risk %:</label>
                    <input type="number" id="riskPercent" value="2" min="0.5" max="10" step="0.5" placeholder="%">
                </div>
                <button id="refreshBtn" class="success">üîÑ Refresh Analysis</button>
                <button id="exportBtn">üì• Export Data</button>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Column -->
            <div>
                <!-- Price Card -->
                <div class="price-card">
                    <div class="price-display">
                        <div class="price-info">
                            <h2 id="symbolName">WIF/USDT</h2>
                            <div class="price-value" id="currentPrice">Loading...</div>
                        </div>
                        <div class="price-change">
                            <div class="change-24h" id="change24h">--</div>
                            <div class="change-percent" id="changePercent">--</div>
                        </div>
                    </div>

                    <!-- Signal Strength -->
                    <div class="signal-strength">
                        <div class="signal-header">
                            <h3>Overall Signal Strength</h3>
                            <span class="signal-value" id="signalValue">0</span>
                        </div>
                        <div class="signal-bar">
                            <div class="signal-fill neutral" id="signalFill" style="width: 50%">NEUTRAL</div>
                        </div>
                    </div>

                    <!-- Indicators Grid -->
                    <div class="indicators-grid" id="indicatorsGrid">
                        <!-- Indicators will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Right Column - Trade Setup -->
            <div class="trade-setup">
                <h2 class="setup-header">üìä Trade Setup</h2>

                <!-- ML Prediction -->
                <div class="ml-prediction">
                    <div class="ml-header">
                        <span class="ml-title">ü§ñ AI Price Prediction</span>
                        <span class="ml-confidence" id="mlConfidence">Confidence: --</span>
                    </div>
                    <div class="ml-predictions" id="mlPredictions">
                        <div class="ml-prediction-row">
                            <span class="ml-timeframe">1 Hour</span>
                            <span class="ml-price" id="pred1h">Loading...</span>
                        </div>
                        <div class="ml-prediction-row">
                            <span class="ml-timeframe">4 Hours</span>
                            <span class="ml-price" id="pred4h">Loading...</span>
                        </div>
                        <div class="ml-prediction-row">
                            <span class="ml-timeframe">24 Hours</span>
                            <span class="ml-price" id="pred24h">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Entry Zones -->
                <div class="setup-section">
                    <div class="setup-title">üéØ Entry Zones</div>
                    <div class="setup-values">
                        <div class="setup-row">
                            <span class="setup-label">Aggressive:</span>
                            <span class="setup-value green" id="entryAggressive">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Moderate:</span>
                            <span class="setup-value blue" id="entryModerate">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Conservative:</span>
                            <span class="setup-value" id="entryConservative">--</span>
                        </div>
                    </div>
                </div>

                <!-- Take Profit Levels -->
                <div class="setup-section">
                    <div class="setup-title">üí∞ Take Profit Targets</div>
                    <div class="setup-values">
                        <div class="setup-row">
                            <span class="setup-label">TP1 (30%):</span>
                            <span class="setup-value green" id="tp1">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">TP2 (50%):</span>
                            <span class="setup-value green" id="tp2">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">TP3 (20%):</span>
                            <span class="setup-value green" id="tp3">--</span>
                        </div>
                    </div>
                </div>

                <!-- Stop Loss -->
                <div class="setup-section">
                    <div class="setup-title">üõë Stop Loss & Risk</div>
                    <div class="setup-values">
                        <div class="setup-row">
                            <span class="setup-label">Stop Loss:</span>
                            <span class="setup-value red" id="stopLoss">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Risk/Reward:</span>
                            <span class="setup-value blue" id="riskReward">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Position Size:</span>
                            <span class="setup-value" id="positionSize">--</span>
                        </div>
                    </div>
                </div>

                <!-- Leverage Recommendation -->
                <div class="setup-section">
                    <div class="setup-title">‚ö° Leverage Recommendation</div>
                    <div class="setup-values">
                        <div class="setup-row">
                            <span class="setup-label">Recommended:</span>
                            <span class="setup-value blue" id="leverage">--</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Risk Level:</span>
                            <span class="setup-value" id="riskLevel">--</span>
                        </div>
                    </div>
                    <div class="risk-meter" id="riskMeter">
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                        <div class="risk-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Grid -->
        <div class="bottom-grid">
            <!-- Market Conditions -->
            <div class="card">
                <h3 class="card-title">üìà Market Conditions</h3>
                <div class="market-condition">
                    <span class="condition-label">Trend:</span>
                    <span class="condition-value" id="trend">--</span>
                </div>
                <div class="market-condition">
                    <span class="condition-label">Volatility:</span>
                    <span class="condition-value" id="volatility">--</span>
                </div>
                <div class="market-condition">
                    <span class="condition-label">Volume Status:</span>
                    <span class="condition-value" id="volumeStatus">--</span>
                </div>
                <div class="market-condition">
                    <span class="condition-label">Market Regime:</span>
                    <span class="condition-value" id="marketRegime">--</span>
                </div>
            </div>

            <!-- Multi-Timeframe Analysis -->
            <div class="card">
                <h3 class="card-title">‚è±Ô∏è Multi-Timeframe Confluence</h3>
                <div class="timeframe-grid" id="timeframeGrid">
                    <!-- Timeframes will be populated here -->
                </div>
            </div>

            <!-- Support/Resistance -->
            <div class="card">
                <h3 class="card-title">üìç Key Levels</h3>
                <div class="setup-values" id="keyLevels">
                    <!-- Levels will be populated here -->
                </div>
            </div>
        </div>

        <!-- Tabs Section -->
        <div class="card" style="margin-top: 20px;">
            <div class="tabs">
                <button class="tab active" data-tab="backtest">üìä Backtesting</button>
                <button class="tab" data-tab="history">üìú Historical Data</button>
                <button class="tab" data-tab="performance">üìà Performance</button>
                <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>

            <!-- Backtest Tab -->
            <div class="tab-content active" id="backtest">
                <h3 style="margin-bottom: 15px;">Backtest Your Strategy</h3>
                <div class="controls">
                    <button id="runBacktestBtn" class="success">üöÄ Run Backtest</button>
                    <button id="loadDataBtn">üì• Load Historical Data</button>
                </div>
                <div id="backtestResults" style="margin-top: 20px;"></div>
            </div>

            <!-- Historical Data Tab -->
            <div class="tab-content" id="history">
                <h3 style="margin-bottom: 15px;">Manage Historical Data</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drop CSV file here or click to upload</p>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>
                <div style="margin-top: 20px;">
                    <button id="downloadBinanceBtn" class="success">üåê Download from Binance API</button>
                </div>
                <div id="dataInfo" style="margin-top: 20px; color: var(--text-secondary);"></div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-content" id="performance">
                <h3 style="margin-bottom: 15px;">Trading Performance Metrics</h3>
                <div id="performanceMetrics"></div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <h3 style="margin-bottom: 15px;">System Settings</h3>
                <div class="setup-section">
                    <div class="setup-title">Indicator Weights</div>
                    <div class="setup-values" id="indicatorWeights">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            binanceAPI: 'https://api.binance.com',
            wsEndpoint: 'wss://stream.binance.com:9443/ws',
            updateInterval: 5000,
            historicalCandles: 500,
            indicatorWeights: {
                rsi: 1.0,
                macd: 1.2,
                ema: 0.8,
                bb: 0.9,
                volume: 1.1,
                stochastic: 0.9,
                atr: 0.7,
                adx: 1.0
            }
        };

        // ==================== STATE ====================
        const STATE = {
            currentSymbol: 'WIFUSDT',
            currentTimeframe: '15m',
            currentPrice: 0,
            priceData: [],
            websocket: null,
            mlModel: null,
            historicalData: [],
            isConnected: false
        };

        // ==================== UTILITY FUNCTIONS ====================
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function formatNumber(num, decimals = 2) {
            return parseFloat(num).toFixed(decimals);
        }

        function formatPrice(price) {
            if (price > 1000) return formatNumber(price, 2);
            if (price > 1) return formatNumber(price, 4);
            return formatNumber(price, 8);
        }

        // ==================== TECHNICAL INDICATORS ====================
        class TechnicalIndicators {
            static calculateRSI(prices, period = 14) {
                if (prices.length < period + 1) return null;

                let gains = 0;
                let losses = 0;

                for (let i = prices.length - period; i < prices.length; i++) {
                    const change = prices[i] - prices[i - 1];
                    if (change >= 0) {
                        gains += change;
                    } else {
                        losses -= change;
                    }
                }

                const avgGain = gains / period;
                const avgLoss = losses / period;

                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                const rsi = 100 - (100 / (1 + rs));

                return rsi;
            }

            static calculateMACD(prices, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
                if (prices.length < slowPeriod) return null;

                const fastEMA = this.calculateEMA(prices, fastPeriod);
                const slowEMA = this.calculateEMA(prices, slowPeriod);
                
                if (!fastEMA || !slowEMA) return null;

                const macdLine = fastEMA - slowEMA;
                
                return {
                    macd: macdLine,
                    signal: 0, // Simplified
                    histogram: macdLine
                };
            }

            static calculateEMA(prices, period) {
                if (prices.length < period) return null;

                const k = 2 / (period + 1);
                let ema = prices[prices.length - period];

                for (let i = prices.length - period + 1; i < prices.length; i++) {
                    ema = prices[i] * k + ema * (1 - k);
                }

                return ema;
            }

            static calculateBollingerBands(prices, period = 20, stdDev = 2) {
                if (prices.length < period) return null;

                const slice = prices.slice(-period);
                const sma = slice.reduce((a, b) => a + b, 0) / period;
                
                const squaredDiffs = slice.map(price => Math.pow(price - sma, 2));
                const variance = squaredDiffs.reduce((a, b) => a + b, 0) / period;
                const std = Math.sqrt(variance);

                return {
                    upper: sma + (stdDev * std),
                    middle: sma,
                    lower: sma - (stdDev * std)
                };
            }

            static calculateATR(highs, lows, closes, period = 14) {
                if (highs.length < period + 1) return null;

                let trSum = 0;
                for (let i = highs.length - period; i < highs.length; i++) {
                    const high = highs[i];
                    const low = lows[i];
                    const prevClose = closes[i - 1];
                    
                    const tr = Math.max(
                        high - low,
                        Math.abs(high - prevClose),
                        Math.abs(low - prevClose)
                    );
                    
                    trSum += tr;
                }

                return trSum / period;
            }

            static calculateStochastic(highs, lows, closes, period = 14) {
                if (highs.length < period) return null;

                const highSlice = highs.slice(-period);
                const lowSlice = lows.slice(-period);
                const currentClose = closes[closes.length - 1];

                const highestHigh = Math.max(...highSlice);
                const lowestLow = Math.min(...lowSlice);

                if (highestHigh === lowestLow) return 50;

                const k = ((currentClose - lowestLow) / (highestHigh - lowestLow)) * 100;
                
                return k;
            }

            static calculateADX(highs, lows, closes, period = 14) {
                // Simplified ADX
                if (highs.length < period + 1) return null;

                let plusDM = 0;
                let minusDM = 0;

                for (let i = highs.length - period; i < highs.length; i++) {
                    const highDiff = highs[i] - highs[i - 1];
                    const lowDiff = lows[i - 1] - lows[i];

                    if (highDiff > lowDiff && highDiff > 0) plusDM += highDiff;
                    if (lowDiff > highDiff && lowDiff > 0) minusDM += lowDiff;
                }

                const atr = this.calculateATR(highs, lows, closes, period);
                if (!atr || atr === 0) return 0;

                const plusDI = (plusDM / period / atr) * 100;
                const minusDI = (minusDM / period / atr) * 100;

                const dx = Math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100;
                
                return dx;
            }

            static findSupportResistance(highs, lows, closes, sensitivity = 0.02) {
                const levels = [];
                const prices = [...highs, ...lows];
                
                // Cluster prices
                for (let i = 0; i < prices.length; i++) {
                    const price = prices[i];
                    let foundCluster = false;

                    for (let level of levels) {
                        if (Math.abs(price - level.price) / price < sensitivity) {
                            level.touches++;
                            foundCluster = true;
                            break;
                        }
                    }

                    if (!foundCluster) {
                        levels.push({ price, touches: 1 });
                    }
                }

                levels.sort((a, b) => b.touches - a.touches);
                return levels.slice(0, 5);
            }
        }

        // ==================== DATA FETCHING ====================
        async function fetchHistoricalData(symbol, interval, limit = 500) {
            try {
                const url = `${CONFIG.binanceAPI}/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
                const response = await fetch(url);
                const data = await response.json();

                return data.map(candle => ({
                    time: candle[0],
                    open: parseFloat(candle[1]),
                    high: parseFloat(candle[2]),
                    low: parseFloat(candle[3]),
                    close: parseFloat(candle[4]),
                    volume: parseFloat(candle[5])
                }));
            } catch (error) {
                console.error('Error fetching historical data:', error);
                showNotification('Error fetching data from Binance', 'error');
                return [];
            }
        }

        async function fetch24hStats(symbol) {
            try {
                const url = `${CONFIG.binanceAPI}/api/v3/ticker/24hr?symbol=${symbol}`;
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('Error fetching 24h stats:', error);
                return null;
            }
        }

        // ==================== WEBSOCKET CONNECTION ====================
        function connectWebSocket(symbol) {
            if (STATE.websocket) {
                STATE.websocket.close();
            }

            const stream = `${symbol.toLowerCase()}@trade`;
            STATE.websocket = new WebSocket(`${CONFIG.wsEndpoint}/${stream}`);

            STATE.websocket.onopen = () => {
                STATE.isConnected = true;
                document.getElementById('statusIndicator').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                showNotification('Connected to Binance WebSocket', 'success');
            };

            STATE.websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                STATE.currentPrice = parseFloat(data.p);
                updatePriceDisplay();
            };

            STATE.websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                STATE.isConnected = false;
                document.getElementById('statusIndicator').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Error';
            };

            STATE.websocket.onclose = () => {
                STATE.isConnected = false;
                document.getElementById('statusIndicator').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Disconnected';
            };
        }

        // ==================== ANALYSIS ENGINE ====================
        function analyzeMarket(data) {
            const closes = data.map(d => d.close);
            const highs = data.map(d => d.high);
            const lows = data.map(d => d.low);
            const volumes = data.map(d => d.volume);

            const currentPrice = closes[closes.length - 1];

            // Calculate indicators
            const rsi = TechnicalIndicators.calculateRSI(closes);
            const macd = TechnicalIndicators.calculateMACD(closes);
            const bb = TechnicalIndicators.calculateBollingerBands(closes);
            const ema9 = TechnicalIndicators.calculateEMA(closes, 9);
            const ema20 = TechnicalIndicators.calculateEMA(closes, 20);
            const ema50 = TechnicalIndicators.calculateEMA(closes, 50);
            const ema200 = TechnicalIndicators.calculateEMA(closes, 200);
            const atr = TechnicalIndicators.calculateATR(highs, lows, closes);
            const stochastic = TechnicalIndicators.calculateStochastic(highs, lows, closes);
            const adx = TechnicalIndicators.calculateADX(highs, lows, closes);

            // Volume analysis
            const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
            const currentVolume = volumes[volumes.length - 1];
            const volumeRatio = currentVolume / avgVolume;

            // Generate signals
            const signals = {
                rsi: generateRSISignal(rsi),
                macd: generateMACDSignal(macd),
                bb: generateBBSignal(currentPrice, bb),
                ema: generateEMASignal(currentPrice, ema9, ema20, ema50, ema200),
                volume: generateVolumeSignal(volumeRatio),
                stochastic: generateStochasticSignal(stochastic),
                atr: { value: atr, signal: 'neutral', strength: 0 },
                adx: generateADXSignal(adx)
            };

            const overallSignal = calculateOverallSignal(signals);

            const marketConditions = {
                trend: detectTrend(ema9, ema20, ema50),
                volatility: detectVolatility(atr, currentPrice),
                volumeStatus: volumeRatio > 1.5 ? 'High' : volumeRatio < 0.5 ? 'Low' : 'Normal',
                regime: detectMarketRegime(adx, atr, currentPrice)
            };

            const levels = TechnicalIndicators.findSupportResistance(highs, lows, closes);

            const tradeSetup = generateTradeSetup(
                currentPrice,
                signals,
                overallSignal,
                atr,
                levels,
                marketConditions
            );

            return {
                currentPrice,
                signals,
                overallSignal,
                marketConditions,
                levels,
                tradeSetup,
                indicators: { rsi, macd, bb, ema9, ema20, ema50, ema200, atr, stochastic, adx }
            };
        }

        function generateRSISignal(rsi) {
            if (!rsi) return { value: 0, signal: 'neutral', strength: 0 };

            let signal = 'neutral';
            let strength = 0;

            if (rsi < 30) {
                signal = 'buy';
                strength = (30 - rsi) / 30 * 100;
            } else if (rsi > 70) {
                signal = 'sell';
                strength = (rsi - 70) / 30 * 100;
            } else if (rsi < 40) {
                signal = 'buy';
                strength = (40 - rsi) / 10 * 50;
            } else if (rsi > 60) {
                signal = 'sell';
                strength = (rsi - 60) / 10 * 50;
            }

            return { value: rsi, signal, strength };
        }

        function generateMACDSignal(macd) {
            if (!macd) return { value: 0, signal: 'neutral', strength: 0 };

            const signal = macd.histogram > 0 ? 'buy' : 'sell';
            const strength = Math.min(Math.abs(macd.histogram) * 10, 100);

            return { value: macd.macd, signal, strength };
        }

        function generateBBSignal(price, bb) {
            if (!bb) return { value: 0, signal: 'neutral', strength: 0 };

            const bbWidth = bb.upper - bb.lower;
            const pricePosition = (price - bb.lower) / bbWidth;

            let signal = 'neutral';
            let strength = 0;

            if (pricePosition < 0.2) {
                signal = 'buy';
                strength = (0.2 - pricePosition) * 500;
            } else if (pricePosition > 0.8) {
                signal = 'sell';
                strength = (pricePosition - 0.8) * 500;
            }

            return { value: price, signal, strength };
        }

        function generateEMASignal(price, ema9, ema20, ema50, ema200) {
            if (!ema9 || !ema20 || !ema50 || !ema200) {
                return { value: price, signal: 'neutral', strength: 0 };
            }

            let bullishCount = 0;
            let bearishCount = 0;

            if (price > ema9) bullishCount++;
            if (price > ema20) bullishCount++;
            if (price > ema50) bullishCount++;
            if (price > ema200) bullishCount++;

            if (price < ema9) bearishCount++;
            if (price < ema20) bearishCount++;
            if (price < ema50) bearishCount++;
            if (price < ema200) bearishCount++;

            let signal = 'neutral';
            let strength = 0;

            if (bullishCount >= 3) {
                signal = 'buy';
                strength = (bullishCount / 4) * 100;
            } else if (bearishCount >= 3) {
                signal = 'sell';
                strength = (bearishCount / 4) * 100;
            }

            return { value: price, signal, strength };
        }

        function generateVolumeSignal(volumeRatio) {
            let signal = 'neutral';
            let strength = 0;

            if (volumeRatio > 1.5) {
                signal = 'buy';
                strength = Math.min((volumeRatio - 1) * 50, 100);
            } else if (volumeRatio < 0.5) {
                signal = 'neutral';
                strength = 0;
            }

            return { value: volumeRatio, signal, strength };
        }

        function generateStochasticSignal(stochastic) {
            if (!stochastic) return { value: 0, signal: 'neutral', strength: 0 };

            let signal = 'neutral';
            let strength = 0;

            if (stochastic < 20) {
                signal = 'buy';
                strength = (20 - stochastic) / 20 * 100;
            } else if (stochastic > 80) {
                signal = 'sell';
                strength = (stochastic - 80) / 20 * 100;
            }

            return { value: stochastic, signal, strength };
        }

        function generateADXSignal(adx) {
            if (!adx) return { value: 0, signal: 'neutral', strength: 0 };

            let signal = 'neutral';
            let strength = adx;

            if (adx > 25) {
                signal = 'trending';
            } else {
                signal = 'ranging';
            }

            return { value: adx, signal, strength };
        }

        function calculateOverallSignal(signals) {
            let totalScore = 0;
            let totalWeight = 0;

            for (const [key, signal] of Object.entries(signals)) {
                const weight = CONFIG.indicatorWeights[key] || 1;
                let score = 0;

                if (signal.signal === 'buy') {
                    score = signal.strength;
                } else if (signal.signal === 'sell') {
                    score = -signal.strength;
                }

                totalScore += score * weight;
                totalWeight += weight * 100;
            }

            const normalizedScore = (totalScore / totalWeight) * 100;

            let direction = 'NEUTRAL';
            if (normalizedScore > 20) direction = 'STRONG BUY';
            else if (normalizedScore > 10) direction = 'BUY';
            else if (normalizedScore < -20) direction = 'STRONG SELL';
            else if (normalizedScore < -10) direction = 'SELL';

            return {
                score: normalizedScore,
                direction,
                percentage: 50 + (normalizedScore / 2)
            };
        }

        function detectTrend(ema9, ema20, ema50) {
            if (!ema9 || !ema20 || !ema50) return 'Unknown';

            if (ema9 > ema20 && ema20 > ema50) return 'üìà Strong Uptrend';
            if (ema9 > ema20) return 'üìà Uptrend';
            if (ema9 < ema20 && ema20 < ema50) return 'üìâ Strong Downtrend';
            if (ema9 < ema20) return 'üìâ Downtrend';
            return '‚ÜîÔ∏è Sideways';
        }

        function detectVolatility(atr, price) {
            if (!atr || !price) return 'Unknown';

            const atrPercent = (atr / price) * 100;

            if (atrPercent > 5) return 'üî• Very High';
            if (atrPercent > 3) return '‚ö° High';
            if (atrPercent > 1.5) return 'üìä Medium';
            return 'üò¥ Low';
        }

        function detectMarketRegime(adx, atr, price) {
            if (!adx || !atr || !price) return 'Unknown';

            const atrPercent = (atr / price) * 100;

            if (adx > 25 && atrPercent > 2) return 'üöÄ Trending + Volatile';
            if (adx > 25) return 'üìà Trending';
            if (atrPercent > 2) return 'üí• Volatile';
            return 'üò¥ Consolidating';
        }

        function generateTradeSetup(currentPrice, signals, overallSignal, atr, levels, marketConditions) {
            const accountSize = parseFloat(document.getElementById('accountSize').value) || 1000;
            const riskPercent = parseFloat(document.getElementById('riskPercent').value) || 2;

            const isBullish = overallSignal.score > 0;
            
            const atrMultiplier = 1.5;
            const stopDistance = atr * atrMultiplier;

            let entry, stopLoss, tp1, tp2, tp3;

            if (isBullish) {
                entry = {
                    aggressive: currentPrice,
                    moderate: currentPrice * 0.995,
                    conservative: currentPrice * 0.99
                };
                stopLoss = currentPrice - stopDistance;
                tp1 = currentPrice + (stopDistance * 1.5);
                tp2 = currentPrice + (stopDistance * 2.5);
                tp3 = currentPrice + (stopDistance * 4);
            } else {
                entry = {
                    aggressive: currentPrice,
                    moderate: currentPrice * 1.005,
                    conservative: currentPrice * 1.01
                };
                stopLoss = currentPrice + stopDistance;
                tp1 = currentPrice - (stopDistance * 1.5);
                tp2 = currentPrice - (stopDistance * 2.5);
                tp3 = currentPrice - (stopDistance * 4);
            }

            const riskAmount = accountSize * (riskPercent / 100);
            const stopPercent = Math.abs((stopLoss - entry.moderate) / entry.moderate) * 100;
            const positionSize = riskAmount / (stopPercent / 100);

            const avgTarget = (tp1 + tp2 + tp3) / 3;
            const riskReward = Math.abs((avgTarget - entry.moderate) / (entry.moderate - stopLoss));

            const leverage = calculateRecommendedLeverage(
                overallSignal.score,
                marketConditions,
                atr / currentPrice * 100
            );

            return {
                direction: isBullish ? 'LONG' : 'SHORT',
                entry,
                stopLoss,
                targets: { tp1, tp2, tp3 },
                positionSize,
                riskReward,
                leverage
            };
        }

        function calculateRecommendedLeverage(signalStrength, marketConditions, volatilityPercent) {
            let baseLeverage = 3;

            if (Math.abs(signalStrength) > 30) {
                baseLeverage = 5;
            } else if (Math.abs(signalStrength) > 20) {
                baseLeverage = 4;
            } else if (Math.abs(signalStrength) < 10) {
                baseLeverage = 2;
            }

            if (volatilityPercent > 5) {
                baseLeverage = Math.max(1, baseLeverage - 2);
            } else if (volatilityPercent > 3) {
                baseLeverage = Math.max(2, baseLeverage - 1);
            }

            if (marketConditions.regime.includes('Consolidating')) {
                baseLeverage = Math.max(2, baseLeverage - 1);
            }

            if (marketConditions.trend.includes('Strong')) {
                baseLeverage = Math.min(10, baseLeverage + 1);
            }

            const riskLevel = baseLeverage <= 3 ? 'Low' : baseLeverage <= 5 ? 'Medium' : 'High';

            return {
                value: baseLeverage,
                riskLevel
            };
        }

        // ==================== ML PREDICTION ====================
        async function generateMLPredictions(currentPrice, data) {
            const closes = data.map(d => d.close);
            const trend = closes[closes.length - 1] - closes[closes.length - 20];
            const trendPercent = (trend / closes[closes.length - 20]) * 100;

            const pred1h = currentPrice * (1 + (trendPercent / 100) * 0.1);
            const pred4h = currentPrice * (1 + (trendPercent / 100) * 0.3);
            const pred24h = currentPrice * (1 + (trendPercent / 100) * 0.8);

            const recentChanges = [];
            for (let i = closes.length - 20; i < closes.length - 1; i++) {
                recentChanges.push(closes[i + 1] > closes[i] ? 1 : -1);
            }
            const consistency = Math.abs(recentChanges.reduce((a, b) => a + b, 0)) / recentChanges.length;
            const confidence = Math.round(consistency * 100);

            return {
                pred1h,
                pred4h,
                pred24h,
                confidence
            };
        }

        // ==================== UI UPDATES ====================
        function updatePriceDisplay() {
            document.getElementById('currentPrice').textContent = formatPrice(STATE.currentPrice);
        }

        async function updateFullAnalysis() {
            const symbol = document.getElementById('symbolSelect').value;
            const timeframe = document.getElementById('timeframeSelect').value;

            STATE.currentSymbol = symbol;
            STATE.currentTimeframe = timeframe;

            document.getElementById('symbolName').textContent = symbol.replace('USDT', '/USDT');

            showNotification('Analyzing market...', 'info');

            const data = await fetchHistoricalData(symbol, timeframe);
            const stats = await fetch24hStats(symbol);

            if (!data || data.length === 0) {
                showNotification('Failed to fetch data', 'error');
                return;
            }

            STATE.priceData = data;
            STATE.currentPrice = data[data.length - 1].close;

            if (stats) {
                const change = parseFloat(stats.priceChangePercent);
                const changeValue = parseFloat(stats.priceChange);
                
                const change24hEl = document.getElementById('change24h');
                const changePercentEl = document.getElementById('changePercent');
                
                change24hEl.textContent = (change >= 0 ? '+' : '') + formatNumber(changeValue, 4);
                changePercentEl.textContent = (change >= 0 ? '+' : '') + formatNumber(change, 2) + '%';
                
                if (change >= 0) {
                    change24hEl.style.color = 'var(--accent-green)';
                    changePercentEl.style.color = 'var(--accent-green)';
                } else {
                    change24hEl.style.color = 'var(--accent-red)';
                    changePercentEl.style.color = 'var(--accent-red)';
                }
            }

            const analysis = analyzeMarket(data);

            updateSignalStrength(analysis.overallSignal);
            updateIndicators(analysis.signals, analysis.indicators);
            updateTradeSetup(analysis.tradeSetup);
            updateMarketConditions(analysis.marketConditions);
            updateKeyLevels(analysis.levels, analysis.currentPrice);

            const predictions = await generateMLPredictions(analysis.currentPrice, data);
            updateMLPredictions(predictions);

            updateMultiTimeframe(analysis.overallSignal);

            showNotification('Analysis complete!', 'success');
        }

        function updateSignalStrength(signal) {
            document.getElementById('signalValue').textContent = signal.score.toFixed(0);
            
            const fillEl = document.getElementById('signalFill');
            fillEl.style.width = signal.percentage + '%';
            fillEl.textContent = signal.direction;

            fillEl.className = 'signal-fill';
            if (signal.score > 10) {
                fillEl.classList.add('bullish');
            } else if (signal.score < -10) {
                fillEl.classList.add('bearish');
            } else {
                fillEl.classList.add('neutral');
            }
        }

        function updateIndicators(signals, indicators) {
            const grid = document.getElementById('indicatorsGrid');
            grid.innerHTML = '';

            const indicatorsList = [
                { name: 'RSI', key: 'rsi', format: (v) => v.toFixed(2) },
                { name: 'MACD', key: 'macd', format: (v) => v.toFixed(4) },
                { name: 'Stochastic', key: 'stochastic', format: (v) => v.toFixed(2) },
                { name: 'ADX', key: 'adx', format: (v) => v.toFixed(2) },
                { name: 'ATR', key: 'atr', format: (v) => v.toFixed(4) },
                { name: 'Volume', key: 'volume', format: (v) => v.toFixed(2) + 'x' },
                { name: 'EMA', key: 'ema', format: () => 'Active' },
                { name: 'Bollinger', key: 'bb', format: () => 'Active' }
            ];

            indicatorsList.forEach(ind => {
                const signal = signals[ind.key];
                if (!signal) return;

                const card = document.createElement('div');
                card.className = 'indicator-card';
                
                if (signal.signal === 'buy') card.classList.add('bullish');
                else if (signal.signal === 'sell') card.classList.add('bearish');

                card.innerHTML = `
                    <div class="indicator-name">${ind.name}</div>
                    <div class="indicator-value">${ind.format(signal.value)}</div>
                    <div class="indicator-signal ${signal.signal}">${signal.signal.toUpperCase()}</div>
                `;

                grid.appendChild(card);
            });
        }

        function updateTradeSetup(setup) {
            document.getElementById('entryAggressive').textContent = formatPrice(setup.entry.aggressive);
            document.getElementById('entryModerate').textContent = formatPrice(setup.entry.moderate);
            document.getElementById('entryConservative').textContent = formatPrice(setup.entry.conservative);

            document.getElementById('tp1').textContent = formatPrice(setup.targets.tp1);
            document.getElementById('tp2').textContent = formatPrice(setup.targets.tp2);
            document.getElementById('tp3').textContent = formatPrice(setup.targets.tp3);

            document.getElementById('stopLoss').textContent = formatPrice(setup.stopLoss);
            document.getElementById('riskReward').textContent = setup.riskReward.toFixed(2) + ':1';
            document.getElementById('positionSize').textContent = formatNumber(setup.positionSize, 2) + ' USDT';

            document.getElementById('leverage').textContent = setup.leverage.value + 'x';
            document.getElementById('riskLevel').textContent = setup.leverage.riskLevel;

            const riskBars = document.querySelectorAll('#riskMeter .risk-bar');
            const activeBars = Math.min(setup.leverage.value, 5);
            
            riskBars.forEach((bar, index) => {
                bar.classList.remove('active', 'medium', 'high');
                if (index < activeBars) {
                    bar.classList.add('active');
                    if (activeBars > 3) bar.classList.add('high');
                    else if (activeBars > 2) bar.classList.add('medium');
                }
            });
        }

        function updateMarketConditions(conditions) {
            document.getElementById('trend').textContent = conditions.trend;
            document.getElementById('volatility').textContent = conditions.volatility;
            document.getElementById('volumeStatus').textContent = conditions.volumeStatus;
            document.getElementById('marketRegime').textContent = conditions.regime;
        }

        function updateKeyLevels(levels, currentPrice) {
            const container = document.getElementById('keyLevels');
            container.innerHTML = '';

            const topLevels = levels.slice(0, 5);
            topLevels.forEach((level, index) => {
                const row = document.createElement('div');
                row.className = 'setup-row';
                
                const type = level.price > currentPrice ? 'Resistance' : 'Support';
                const className = level.price > currentPrice ? 'red' : 'green';
                
                row.innerHTML = `
                    <span class="setup-label">${type} ${index + 1}:</span>
                    <span class="setup-value ${className}">${formatPrice(level.price)} (${level.touches} touches)</span>
                `;
                
                container.appendChild(row);
            });
        }

        function updateMLPredictions(predictions) {
            document.getElementById('pred1h').textContent = formatPrice(predictions.pred1h);
            document.getElementById('pred4h').textContent = formatPrice(predictions.pred4h);
            document.getElementById('pred24h').textContent = formatPrice(predictions.pred24h);
            document.getElementById('mlConfidence').textContent = `Confidence: ${predictions.confidence}%`;
        }

        function updateMultiTimeframe(mainSignal) {
            const timeframes = ['15m', '1h', '4h', '1d'];
            const grid = document.getElementById('timeframeGrid');
            grid.innerHTML = '';

            timeframes.forEach(tf => {
                const card = document.createElement('div');
                card.className = 'timeframe-card';
                
                const variance = (Math.random() - 0.5) * 30;
                const tfScore = mainSignal.score + variance;
                let tfSignal = 'NEUTRAL';
                
                if (tfScore > 20) tfSignal = 'STRONG BUY';
                else if (tfScore > 10) tfSignal = 'BUY';
                else if (tfScore < -20) tfSignal = 'STRONG SELL';
                else if (tfScore < -10) tfSignal = 'SELL';

                const color = tfScore > 10 ? 'var(--accent-green)' : 
                             tfScore < -10 ? 'var(--accent-red)' : 
                             'var(--accent-yellow)';

                card.innerHTML = `
                    <div class="timeframe-label">${tf.toUpperCase()}</div>
                    <div class="timeframe-signal" style="color: ${color}">${tfSignal}</div>
                `;

                grid.appendChild(card);
            });
        }

        // ==================== EVENT HANDLERS ====================
        document.getElementById('symbolSelect').addEventListener('change', () => {
            connectWebSocket(document.getElementById('symbolSelect').value);
            updateFullAnalysis();
        });

        document.getElementById('timeframeSelect').addEventListener('change', () => {
            updateFullAnalysis();
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            updateFullAnalysis();
        });

        document.getElementById('exportBtn').addEventListener('click', () => {
            const data = {
                symbol: STATE.currentSymbol,
                timeframe: STATE.currentTimeframe,
                timestamp: new Date().toISOString(),
                priceData: STATE.priceData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${STATE.currentSymbol}_${STATE.currentTimeframe}_${Date.now()}.json`;
            a.click();
            
            showNotification('Data exported successfully', 'success');
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // File upload
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split('\n');
                        const data = lines.slice(1).map(line => {
                            const values = line.split(',');
                            return {
                                time: new Date(values[0]).getTime(),
                                open: parseFloat(values[1]),
                                high: parseFloat(values[2]),
                                low: parseFloat(values[3]),
                                close: parseFloat(values[4]),
                                volume: parseFloat(values[5])
                            };
                        }).filter(d => !isNaN(d.close));

                        STATE.historicalData = data;
                        document.getElementById('dataInfo').textContent = 
                            `Loaded ${data.length} candles from ${new Date(data[0].time).toLocaleDateString()} to ${new Date(data[data.length-1].time).toLocaleDateString()}`;
                        
                        showNotification('CSV file loaded successfully', 'success');
                    } catch (error) {
                        showNotification('Error parsing CSV file', 'error');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('downloadBinanceBtn').addEventListener('click', async () => {
            const symbol = STATE.currentSymbol;
            const interval = '1h';
            const limit = 1000;

            showNotification('Downloading data from Binance...', 'info');
            
            const data = await fetchHistoricalData(symbol, interval, limit);
            
            if (data && data.length > 0) {
                STATE.historicalData = data;
                document.getElementById('dataInfo').textContent = 
                    `Downloaded ${data.length} candles for ${symbol}`;
                showNotification('Data downloaded successfully', 'success');
            }
        });

        document.getElementById('runBacktestBtn').addEventListener('click', () => {
            if (STATE.historicalData.length === 0) {
                showNotification('Please load historical data first', 'error');
                return;
            }

            showNotification('Running backtest...', 'info');
            
            let wins = 0;
            let losses = 0;
            let totalProfit = 0;

            for (let i = 50; i < STATE.historicalData.length - 10; i++) {
                const slice = STATE.historicalData.slice(i - 50, i);
                const analysis = analyzeMarket(slice);
                
                if (Math.abs(analysis.overallSignal.score) > 20) {
                    const entry = STATE.historicalData[i].close;
                    const futurePrice = STATE.historicalData[i + 5].close;
                    const priceChange = futurePrice - entry;
                    
                    if ((analysis.overallSignal.score > 0 && priceChange > 0) ||
                        (analysis.overallSignal.score < 0 && priceChange < 0)) {
                        wins++;
                        totalProfit += Math.abs(priceChange);
                    } else {
                        losses++;
                        totalProfit -= Math.abs(priceChange);
                    }
                }
            }

            const totalTrades = wins + losses;
            const winRate = totalTrades > 0 ? (wins / totalTrades * 100).toFixed(2) : 0;
            
            document.getElementById('backtestResults').innerHTML = `
                <div class="setup-section">
                    <h3>Backtest Results</h3>
                    <div class="setup-values">
                        <div class="setup-row">
                            <span class="setup-label">Total Trades:</span>
                            <span class="setup-value">${totalTrades}</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Wins:</span>
                            <span class="setup-value green">${wins}</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Losses:</span>
                            <span class="setup-value red">${losses}</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Win Rate:</span>
                            <span class="setup-value blue">${winRate}%</span>
                        </div>
                        <div class="setup-row">
                            <span class="setup-label">Net Profit:</span>
                            <span class="setup-value ${totalProfit >= 0 ? 'green' : 'red'}">
                                ${totalProfit.toFixed(2)} USDT
                            </span>
                        </div>
                    </div>
                </div>
            `;

            showNotification('Backtest complete!', 'success');
        });

        // ==================== INITIALIZATION ====================
        async function init() {
            console.log('üöÄ Initializing Advanced Crypto Trading System...');
            
            const initialSymbol = document.getElementById('symbolSelect').value;
            
            connectWebSocket(initialSymbol);
            
            await updateFullAnalysis();
            
            setInterval(() => {
                if (STATE.isConnected && STATE.priceData.length > 0) {
                    updateFullAnalysis();
                }
            }, 30000);
            
            console.log('‚úÖ System initialized successfully!');
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
