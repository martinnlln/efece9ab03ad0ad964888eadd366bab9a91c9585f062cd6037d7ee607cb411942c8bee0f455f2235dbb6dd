<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Order Flow Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr 200px;
            height: 100vh;
            gap: 1px;
            background: #1a1f3a;
        }

        .header {
            grid-column: 1 / -1;
            background: #1a1f3a;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #2a3f5f;
        }

        .header h1 {
            font-size: 24px;
            color: #4a9eff;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        select, input {
            background: #0a0e27;
            color: #e0e0e0;
            border: 1px solid #2a3f5f;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .orderbook {
            background: #0a0e27;
            padding: 20px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            color: #4a9eff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .book-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 8px 0;
            border-bottom: 1px solid #2a3f5f;
            font-size: 12px;
            color: #8090a0;
            margin-bottom: 10px;
        }

        .book-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 6px 0;
            font-size: 13px;
            position: relative;
            font-family: 'Courier New', monospace;
        }

        .book-row::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--depth);
            opacity: 0.15;
        }

        .asks .book-row::before {
            background: #ff4444;
        }

        .bids .book-row::before {
            background: #44ff44;
        }

        .asks .book-row {
            color: #ff6666;
        }

        .bids .book-row {
            color: #66ff66;
        }

        .book-row.large-order {
            background: rgba(255, 170, 68, 0.1);
            border-left: 3px solid #ffaa44;
            padding-left: 5px;
            font-weight: 600;
        }

        .spread {
            text-align: center;
            padding: 12px;
            margin: 10px 0;
            background: #1a1f3a;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
        }

        .main-section {
            background: #0a0e27;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
            margin-bottom: 15px;
        }

        .metrics {
            background: #0a0e27;
            padding: 20px;
            overflow-y: auto;
        }

        .metric-card {
            background: #1a1f3a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4a9eff;
        }

        .metric-card h3 {
            font-size: 12px;
            color: #8090a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .metric-value.positive {
            color: #44ff44;
        }

        .metric-value.negative {
            color: #ff4444;
        }

        .metric-value.neutral {
            color: #ffaa44;
        }

        .metric-subtitle {
            font-size: 11px;
            color: #6070a0;
            margin-top: 5px;
        }

        .signal-box {
            background: linear-gradient(135deg, rgba(74, 158, 255, 0.1), rgba(74, 158, 255, 0.05));
            border: 2px solid #4a9eff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .signal-box.bullish {
            background: linear-gradient(135deg, rgba(68, 255, 68, 0.1), rgba(68, 255, 68, 0.05));
            border-color: #44ff44;
        }

        .signal-box.bearish {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 68, 68, 0.05));
            border-color: #ff4444;
        }

        .signal-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8090a0;
            margin-bottom: 8px;
        }

        .signal-value {
            font-size: 28px;
            font-weight: 700;
        }

        .signal-description {
            font-size: 11px;
            color: #8090a0;
            margin-top: 8px;
        }

        .imbalance-bar {
            height: 30px;
            background: linear-gradient(to right, #ff4444 0%, #ffaa44 50%, #44ff44 100%);
            border-radius: 4px;
            position: relative;
            margin: 10px 0;
        }

        .imbalance-marker {
            position: absolute;
            top: -5px;
            bottom: -5px;
            width: 3px;
            background: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .trades-feed {
            background: #1a1f3a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .trade-item {
            display: grid;
            grid-template-columns: 60px 1fr 1fr;
            padding: 4px 0;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            border-bottom: 1px solid #0a0e27;
        }

        .trade-item.buy {
            color: #66ff66;
        }

        .trade-item.sell {
            color: #ff6666;
        }

        .large-trade {
            background: rgba(255, 170, 68, 0.1);
            border-left: 3px solid #ffaa44;
            padding-left: 5px;
            font-weight: 600;
        }

        .bottom-panel {
            grid-column: 1 / -1;
            background: #0a0e27;
            padding: 15px 20px;
            overflow-y: auto;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .analysis-card {
            background: #1a1f3a;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #2a3f5f;
        }

        .analysis-card h4 {
            font-size: 11px;
            color: #8090a0;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .analysis-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .badge.green {
            background: rgba(68, 255, 68, 0.2);
            color: #44ff44;
        }

        .badge.red {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        .badge.yellow {
            background: rgba(255, 170, 68, 0.2);
            color: #ffaa44;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0e27;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a3f5f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a4f6f;
        }

        .divergence-indicator {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
        }

        .divergence-indicator.active {
            background: rgba(255, 170, 68, 0.2);
            border: 1px solid #ffaa44;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .volume-profile {
            background: #1a1f3a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .vp-bar {
            display: flex;
            align-items: center;
            margin: 2px 0;
            font-size: 11px;
            font-family: 'Courier New', monospace;
        }

        .vp-price {
            width: 80px;
            color: #8090a0;
        }

        .vp-visual {
            flex: 1;
            height: 14px;
            background: rgba(74, 158, 255, 0.3);
            border-radius: 2px;
            position: relative;
        }

        .vp-visual.poc {
            background: rgba(255, 170, 68, 0.5);
            border: 1px solid #ffaa44;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ Advanced Order Flow Pro</h1>
            <div class="controls">
                <select id="exchangeSelect">
                    <option value="binance">Binance Spot</option>
                    <option value="binance-futures">Binance Futures</option>
                </select>
                <select id="symbolSelect">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="WIFUSDT">WIF/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                </select>
                <input type="number" id="minOrderSize" placeholder="Min Order ($)" value="10000">
                <div class="status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Order Book Section -->
        <div class="orderbook">
            <div class="section-title">ðŸ“Š Order Book Depth</div>
            <div class="book-header">
                <div>Price</div>
                <div>Size</div>
                <div>Total ($)</div>
            </div>
            <div class="asks" id="asksContainer"></div>
            <div class="spread" id="spreadDisplay">Spread: --</div>
            <div class="bids" id="bidsContainer"></div>

            <div class="volume-profile" style="margin-top: 20px;">
                <div class="section-title">ðŸ“ˆ Volume Profile</div>
                <div id="volumeProfileContainer"></div>
            </div>
        </div>

        <!-- Main Chart Section -->
        <div class="main-section">
            <div class="section-title">Cumulative Delta & Price Action</div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
            <div class="chart-container" style="flex: 0.6;">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="metrics">
            <div class="signal-box" id="mainSignal">
                <div class="signal-title">Market Signal</div>
                <div class="signal-value neutral" id="signalValue">NEUTRAL</div>
                <div class="signal-description" id="signalDesc">Waiting for setup...</div>
            </div>

            <div class="metric-card">
                <h3>Cumulative Delta</h3>
                <div class="metric-value" id="cumulativeDelta">0</div>
                <div class="metric-subtitle" id="deltaSubtitle">Net pressure</div>
                <div class="divergence-indicator" id="divergenceIndicator"></div>
            </div>

            <div class="metric-card">
                <h3>Order Book Imbalance</h3>
                <div class="metric-value" id="imbalanceValue">50%</div>
                <div class="imbalance-bar">
                    <div class="imbalance-marker" id="imbalanceMarker" style="left: 50%;"></div>
                </div>
                <div class="metric-subtitle" id="imbalanceSubtitle">Bid/Ask Ratio</div>
            </div>

            <div class="metric-card">
                <h3>Current Price</h3>
                <div class="metric-value neutral" id="currentPrice">--</div>
                <div class="metric-subtitle" id="priceChange">--</div>
            </div>

            <div class="trades-feed">
                <h3 class="section-title">ðŸ”¥ Large Orders</h3>
                <div id="largeTradesContainer"></div>
            </div>
        </div>

        <!-- Bottom Analysis Panel -->
        <div class="bottom-panel">
            <div class="section-title">ðŸ“Š Advanced Analytics</div>
            <div class="analysis-grid" id="analyticsGrid">
                <div class="analysis-card">
                    <h4>5min Volume</h4>
                    <div class="analysis-value neutral" id="volume5min">$0</div>
                    <span class="badge" id="volumeBadge">NORMAL</span>
                </div>
                <div class="analysis-card">
                    <h4>Delta/Price Correlation</h4>
                    <div class="analysis-value" id="correlation">--</div>
                    <span class="badge" id="correlationBadge">--</span>
                </div>
                <div class="analysis-card">
                    <h4>Absorption Level</h4>
                    <div class="analysis-value" id="absorption">None</div>
                    <span class="badge" id="absorptionBadge">--</span>
                </div>
                <div class="analysis-card">
                    <h4>Buy/Sell Ratio (5min)</h4>
                    <div class="analysis-value" id="buySellRatio">--</div>
                    <span class="badge" id="ratioBadge">--</span>
                </div>
                <div class="analysis-card">
                    <h4>Momentum</h4>
                    <div class="analysis-value" id="momentum">--</div>
                    <span class="badge" id="momentumBadge">--</span>
                </div>
                <div class="analysis-card">
                    <h4>POC (Point of Control)</h4>
                    <div class="analysis-value" id="poc">--</div>
                    <span class="badge" id="pocBadge">--</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        let ws = null;
        let wsDepth = null;
        let currentSymbol = 'WIFUSDT';
        let minOrderSizeUSD = 10000;

        // ==================== DATA STORAGE ====================
        let orderBook = { bids: [], asks: [] };
        let trades = [];
        let largeTrades = [];
        let cumulativeDeltaValue = 0;
        let deltaHistory = [];
        let priceHistory = [];
        let volumeHistory = [];
        let timestamps = [];
        let buyVolume5min = 0;
        let sellVolume5min = 0;
        let lastPrice = 0;
        let startPrice = 0;
        let highestPrice = 0;
        let lowestPrice = Infinity;
        let volumeByPrice = {};

        // ==================== CHART SETUP ====================
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        const mainChart = new Chart(ctxMain, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Cumulative Delta',
                    data: [],
                    borderColor: '#4a9eff',
                    backgroundColor: 'rgba(74, 158, 255, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    yAxisID: 'y',
                    tension: 0.4
                }, {
                    label: 'Price',
                    data: [],
                    borderColor: '#ffaa44',
                    backgroundColor: 'rgba(255, 170, 68, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'y1',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: { color: '#e0e0e0' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: '#2a3f5f' },
                        ticks: { color: '#8090a0', maxRotation: 0 }
                    },
                    y: {
                        position: 'left',
                        grid: { color: '#2a3f5f' },
                        ticks: { color: '#4a9eff' },
                        title: { display: true, text: 'Cumulative Delta', color: '#4a9eff' }
                    },
                    y1: {
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#ffaa44' },
                        title: { display: true, text: 'Price', color: '#ffaa44' }
                    }
                }
            }
        });

        const ctxVolume = document.getElementById('volumeChart').getContext('2d');
        const volumeChart = new Chart(ctxVolume, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Buy Volume',
                    data: [],
                    backgroundColor: 'rgba(68, 255, 68, 0.5)',
                }, {
                    label: 'Sell Volume',
                    data: [],
                    backgroundColor: 'rgba(255, 68, 68, 0.5)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#e0e0e0' } }
                },
                scales: {
                    x: {
                        stacked: true,
                        grid: { color: '#2a3f5f' },
                        ticks: { color: '#8090a0', maxRotation: 0 }
                    },
                    y: {
                        stacked: true,
                        grid: { color: '#2a3f5f' },
                        ticks: { color: '#8090a0' }
                    }
                }
            }
        });

        // ==================== WEBSOCKET CONNECTION ====================
        function connectWebSocket() {
            const symbol = currentSymbol.toLowerCase();
            
            if (ws) ws.close();
            if (wsDepth) wsDepth.close();

            // Reset data
            cumulativeDeltaValue = 0;
            deltaHistory = [];
            priceHistory = [];
            volumeHistory = [];
            timestamps = [];
            trades = [];
            largeTrades = [];
            buyVolume5min = 0;
            sellVolume5min = 0;
            volumeByPrice = {};
            highestPrice = 0;
            lowestPrice = Infinity;

            updateStatus('Connecting...', false);

            ws = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@trade`);
            ws.onopen = () => updateStatus('Connected', true);
            ws.onmessage = (event) => handleTrade(JSON.parse(event.data));
            ws.onerror = () => updateStatus('Connection Error', false);
            ws.onclose = () => {
                updateStatus('Disconnected', false);
                setTimeout(connectWebSocket, 3000);
            };

            wsDepth = new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@depth20@100ms`);
            wsDepth.onmessage = (event) => handleDepth(JSON.parse(event.data));
        }

        // ==================== TRADE HANDLER ====================
        function handleTrade(data) {
            const price = parseFloat(data.p);
            const quantity = parseFloat(data.q);
            const isBuyerMaker = data.m;
            const side = isBuyerMaker ? 'sell' : 'buy';
            const value = price * quantity;
            
            if (lastPrice === 0) {
                lastPrice = price;
                startPrice = price;
            }
            lastPrice = price;
            highestPrice = Math.max(highestPrice, price);
            lowestPrice = Math.min(lowestPrice, price);

            // Calculate delta
            const delta = isBuyerMaker ? -quantity : quantity;
            cumulativeDeltaValue += delta;

            // Track buy/sell volume
            if (side === 'buy') {
                buyVolume5min += value;
            } else {
                sellVolume5min += value;
            }

            // Volume profile
            const priceLevel = (Math.round(price * 100) / 100).toFixed(2);
            if (!volumeByPrice[priceLevel]) {
                volumeByPrice[priceLevel] = { buy: 0, sell: 0, total: 0 };
            }
            if (side === 'buy') {
                volumeByPrice[priceLevel].buy += value;
            } else {
                volumeByPrice[priceLevel].sell += value;
            }
            volumeByPrice[priceLevel].total += value;

            // Add to history
            const now = new Date();
            timestamps.push(now.toLocaleTimeString());
            deltaHistory.push(cumulativeDeltaValue);
            priceHistory.push(price);
            volumeHistory.push({ buy: side === 'buy' ? value : 0, sell: side === 'sell' ? value : 0 });

            if (timestamps.length > 100) {
                timestamps.shift();
                deltaHistory.shift();
                priceHistory.shift();
                const removed = volumeHistory.shift();
                buyVolume5min -= removed.buy;
                sellVolume5min -= removed.sell;
            }

            // Update charts
            updateCharts();

            // Large trades
            if (value >= minOrderSizeUSD) {
                largeTrades.unshift({
                    time: now.toLocaleTimeString(),
                    side: side,
                    price: price.toFixed(4),
                    value: value.toFixed(0)
                });
                if (largeTrades.length > 10) largeTrades.pop();
            }

            // Update UI
            updateMetrics();
            analyzeMarket();
        }

        // ==================== DEPTH HANDLER ====================
        function handleDepth(data) {
            orderBook.bids = data.bids.slice(0, 15);
            orderBook.asks = data.asks.slice(0, 15);
            updateOrderBook();
            calculateImbalance();
        }

        // ==================== UPDATE FUNCTIONS ====================
        function updateCharts() {
            mainChart.data.labels = timestamps;
            mainChart.data.datasets[0].data = deltaHistory;
            mainChart.data.datasets[1].data = priceHistory;
            mainChart.update('none');

            volumeChart.data.labels = timestamps;
            volumeChart.data.datasets[0].data = volumeHistory.map(v => v.buy / 1000);
            volumeChart.data.datasets[1].data = volumeHistory.map(v => -v.sell / 1000);
            volumeChart.update('none');
        }

        function updateMetrics() {
            // Cumulative Delta
            const deltaEl = document.getElementById('cumulativeDelta');
            const deltaClass = cumulativeDeltaValue > 0 ? 'positive' : cumulativeDeltaValue < 0 ? 'negative' : 'neutral';
            deltaEl.className = 'metric-value ' + deltaClass;
            deltaEl.textContent = cumulativeDeltaValue.toFixed(2);

            const deltaSubtitle = document.getElementById('deltaSubtitle');
            deltaSubtitle.textContent = cumulativeDeltaValue > 0 ? 'ðŸŸ¢ Buyers dominant' : cumulativeDeltaValue < 0 ? 'ðŸ”´ Sellers dominant' : 'âšª Balanced';

            // Price
            document.getElementById('currentPrice').textContent = '$' + lastPrice.toFixed(4);
            const priceChangePercent = ((lastPrice - startPrice) / startPrice * 100).toFixed(2);
            const priceChangeEl = document.getElementById('priceChange');
            priceChangeEl.textContent = priceChangePercent > 0 ? `+${priceChangePercent}%` : `${priceChangePercent}%`;
            priceChangeEl.style.color = priceChangePercent > 0 ? '#44ff44' : '#ff4444';

            // Large trades
            const largeTradesContainer = document.getElementById('largeTradesContainer');
            largeTradesContainer.innerHTML = largeTrades.map(trade => `
                <div class="trade-item ${trade.side} large-trade">
                    <div>${trade.time}</div>
                    <div>${trade.price}</div>
                    <div>$${(trade.value/1000).toFixed(1)}K</div>
                </div>
            `).join('');
        }

        function updateOrderBook() {
            const allTotals = [...orderBook.bids, ...orderBook.asks].map(([p, q]) => parseFloat(p) * parseFloat(q));
            const maxTotal = Math.max(...allTotals);
            const threshold = maxTotal * 0.3;

            const asksContainer = document.getElementById('asksContainer');
            asksContainer.innerHTML = orderBook.asks.slice().reverse().map(([price, size]) => {
                const total = parseFloat(price) * parseFloat(size);
                const depth = (total / maxTotal * 100);
                const isLarge = total > threshold;
                return `
                    <div class="book-row ${isLarge ? 'large-order' : ''}" style="--depth: ${depth}%;">
                        <div>${parseFloat(price).toFixed(4)}</div>
                        <div>${parseFloat(size).toFixed(4)}</div>
                        <div>$${(total/1000).toFixed(1)}K</div>
                    </div>
                `;
            }).join('');

            const bidsContainer = document.getElementById('bidsContainer');
            bidsContainer.innerHTML = orderBook.bids.map(([price, size]) => {
                const total = parseFloat(price) * parseFloat(size);
                const depth = (total / maxTotal * 100);
                const isLarge = total > threshold;
                return `
                    <div class="book-row ${isLarge ? 'large-order' : ''}" style="--depth: ${depth}%;">
                        <div>${parseFloat(price).toFixed(4)}</div>
                        <div>${parseFloat(size).toFixed(4)}</div>
                        <div>$${(total/1000).toFixed(1)}K</div>
                    </div>
                `;
            }).join('');

            if (orderBook.bids.length > 0 && orderBook.asks.length > 0) {
                const bestBid = parseFloat(orderBook.bids[0][0]);
                const bestAsk = parseFloat(orderBook.asks[0][0]);
                const spread = bestAsk - bestBid;
                const spreadPercent = (spread / bestBid * 100).toFixed(3);
                document.getElementById('spreadDisplay').textContent = 
                    `Spread: $${spread.toFixed(4)} (${spreadPercent}%)`;
            }

            updateVolumeProfile();
        }

        function updateVolumeProfile() {
            const sortedPrices = Object.keys(volumeByPrice)
                .map(p => parseFloat(p))
                .filter(p => p >= lowestPrice && p <= highestPrice)
                .sort((a, b) => b - a)
                .slice(0, 20);

            const maxVolume = Math.max(...sortedPrices.map(p => volumeByPrice[p.toFixed(2)]?.total || 0));
            const pocPrice = sortedPrices.reduce((max, p) => {
                const vol = volumeByPrice[p.toFixed(2)]?.total || 0;
                const maxVol = volumeByPrice[max.toFixed(2)]?.total || 0;
                return vol > maxVol ? p : max;
            }, sortedPrices[0]);

            const vpContainer = document.getElementById('volumeProfileContainer');
            vpContainer.innerHTML = sortedPrices.map(price => {
                const priceKey = price.toFixed(2);
                const data = volumeByPrice[priceKey] || { total: 0 };
                const width = (data.total / maxVolume * 100);
                const isPOC = Math.abs(price - pocPrice) < 0.01;
                
                return `
                    <div class="vp-bar">
                        <div class="vp-price">${price.toFixed(2)}</div>
                        <div class="vp-visual ${isPOC ? 'poc' : ''}" style="width: ${width}%;"></div>
                    </div>
                `;
            }).join('');

            document.getElementById('poc').textContent = '$' + pocPrice.toFixed(2);
            const nearPOC = Math.abs(lastPrice - pocPrice) / pocPrice < 0.005;
            const pocBadge = document.getElementById('pocBadge');
            pocBadge.textContent = nearPOC ? 'NEAR POC' : 'AWAY';
            pocBadge.className = 'badge ' + (nearPOC ? 'yellow' : 'red');
        }

        function calculateImbalance() {
            if (orderBook.bids.length === 0 || orderBook.asks.length === 0) return;

            const bidVolume = orderBook.bids.reduce((sum, [p, q]) => sum + parseFloat(q) * parseFloat(p), 0);
            const askVolume = orderBook.asks.reduce((sum, [p, q]) => sum + parseFloat(q) * parseFloat(p), 0);
            
            const totalVolume = bidVolume + askVolume;
            const bidPercent = (bidVolume / totalVolume * 100).toFixed(1);

            document.getElementById('imbalanceValue').textContent = `${bidPercent}%`;
            document.getElementById('imbalanceMarker').style.left = bidPercent + '%';

            const imbalanceSubtitle = document.getElementById('imbalanceSubtitle');
            if (bidPercent > 65) {
                imbalanceSubtitle.textContent = 'ðŸŸ¢ Strong bid support';
            } else if (bidPercent < 35) {
                imbalanceSubtitle.textContent = 'ðŸ”´ Weak bid support';
            } else {
                imbalanceSubtitle.textContent = 'âšª Balanced';
            }
        }

        function analyzeMarket() {
            // Volume analysis
            const totalVolume = buyVolume5min + sellVolume5min;
            document.getElementById('volume5min').textContent = '$' + (totalVolume / 1000).toFixed(1) + 'K';
            
            const avgVolume = volumeHistory.reduce((sum, v) => sum + v.buy + v.sell, 0) / volumeHistory.length;
            const volumeRatio = totalVolume / (avgVolume * volumeHistory.length);
            const volumeBadge = document.getElementById('volumeBadge');
            if (volumeRatio > 1.5) {
                volumeBadge.textContent = 'HIGH';
                volumeBadge.className = 'badge green';
            } else if (volumeRatio < 0.5) {
                volumeBadge.textContent = 'LOW';
                volumeBadge.className = 'badge red';
            } else {
                volumeBadge.textContent = 'NORMAL';
                volumeBadge.className = 'badge yellow';
            }

            // Buy/Sell ratio
            const ratio = buyVolume5min / (sellVolume5min || 1);
            document.getElementById('buySellRatio').textContent = ratio.toFixed(2) + ':1';
            const ratioBadge = document.getElementById('ratioBadge');
            if (ratio > 1.3) {
                ratioBadge.textContent = 'BULLISH';
                ratioBadge.className = 'badge green';
            } else if (ratio < 0.7) {
                ratioBadge.textContent = 'BEARISH';
                ratioBadge.className = 'badge red';
            } else {
                ratioBadge.textContent = 'NEUTRAL';
                ratioBadge.className = 'badge yellow';
            }

            // Divergence detection
            if (deltaHistory.length >= 20) {
                const recentDelta = deltaHistory.slice(-10);
                const recentPrice = priceHistory.slice(-10);
                
                const deltaTrend = recentDelta[recentDelta.length - 1] - recentDelta[0];
                const priceTrend = recentPrice[recentPrice.length - 1] - recentPrice[0];
                
                const divergence = (deltaTrend > 0 && priceTrend < 0) || (deltaTrend < 0 && priceTrend > 0);
                
                const divIndicator = document.getElementById('divergenceIndicator');
                if (divergence) {
                    divIndicator.className = 'divergence-indicator active';
                    divIndicator.textContent = deltaTrend > 0 ? 'âš ï¸ BULLISH DIVERGENCE' : 'âš ï¸ BEARISH DIVERGENCE';
                } else {
                    divIndicator.className = 'divergence-indicator';
                    divIndicator.textContent = '';
                }

                // Main signal
                const signalBox = document.getElementById('mainSignal');
                const signalValue = document.getElementById('signalValue');
                const signalDesc = document.getElementById('signalDesc');
                
                if (divergence && deltaTrend > 0) {
                    signalBox.className = 'signal-box bullish';
                    signalValue.textContent = 'LONG SETUP';
                    signalValue.className = 'signal-value positive';
                    signalDesc.textContent = 'Bullish divergence detected - buyers stepping in';
                } else if (divergence && deltaTrend < 0) {
                    signalBox.className = 'signal-box bearish';
                    signalValue.textContent = 'SHORT SETUP';
                    signalValue.className = 'signal-value negative';
                    signalDesc.textContent = 'Bearish divergence detected - sellers taking control';
                } else {
                    signalBox.className = 'signal-box';
                    signalValue.textContent = 'NEUTRAL';
                    signalValue.className = 'signal-value neutral';
                    signalDesc.textContent = 'No clear setup - waiting for divergence';
                }
            }

            // Correlation
            if (deltaHistory.length >= 20) {
                const corr = calculateCorrelation(deltaHistory.slice(-20), priceHistory.slice(-20));
                document.getElementById('correlation').textContent = corr.toFixed(2);
                const corrBadge = document.getElementById('correlationBadge');
                if (corr > 0.7) {
                    corrBadge.textContent = 'STRONG';
                    corrBadge.className = 'badge green';
                } else if (corr < -0.7) {
                    corrBadge.textContent = 'DIVERGING';
                    corrBadge.className = 'badge red';
                } else {
                    corrBadge.textContent = 'WEAK';
                    corrBadge.className = 'badge yellow';
                }
            }

            // Momentum
            if (priceHistory.length >= 10) {
                const momentum = priceHistory[priceHistory.length - 1] - priceHistory[priceHistory.length - 10];
                document.getElementById('momentum').textContent = momentum.toFixed(4);
                const momentumBadge = document.getElementById('momentumBadge');
                if (momentum > 0) {
                    momentumBadge.textContent = 'UP';
                    momentumBadge.className = 'badge green';
                } else if (momentum < 0) {
                    momentumBadge.textContent = 'DOWN';
                    momentumBadge.className = 'badge red';
                } else {
                    momentumBadge.textContent = 'FLAT';
                    momentumBadge.className = 'badge yellow';
                }
            }
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            connectWebSocket();
        });

        document.getElementById('minOrderSize').addEventListener('change', (e) => {
            minOrderSizeUSD = parseFloat(e.target.value) || 10000;
        });

        // ==================== INITIALIZE ====================
        connectWebSocket();
    </script>
</body>
</html>
