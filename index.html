import React, { useState, useEffect, useRef } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Area, AreaChart, ScatterChart, Scatter } from 'recharts';
import { TrendingUp, TrendingDown, Minus, Search, AlertTriangle, Target, DollarSign, Activity, Brain, BarChart3, Settings, Zap, Shield, Play, Database, BookOpen, Bell, ScanSearch } from 'lucide-react';
import * as tf from 'tensorflow';

// ==================== COMPLETE TECHNICAL INDICATORS LIBRARY ====================
const TechnicalIndicators = {
  SMA: (data, period) => {
    const result = [];
    for (let i = period - 1; i < data.length; i++) {
      const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
      result.push(sum / period);
    }
    return result;
  },

  EMA: (data, period) => {
    const result = [];
    const multiplier = 2 / (period + 1);
    result[0] = data[0];
    for (let i = 1; i < data.length; i++) {
      result[i] = (data[i] - result[i - 1]) * multiplier + result[i - 1];
    }
    return result;
  },

  RSI: (data, period = 14) => {
    const changes = [];
    for (let i = 1; i < data.length; i++) {
      changes.push(data[i] - data[i - 1]);
    }
    const result = [];
    for (let i = period; i < changes.length; i++) {
      const gains = changes.slice(i - period, i).filter(c => c > 0);
      const losses = changes.slice(i - period, i).filter(c => c < 0).map(c => Math.abs(c));
      const avgGain = gains.length > 0 ? gains.reduce((a, b) => a + b, 0) / period : 0;
      const avgLoss = losses.length > 0 ? losses.reduce((a, b) => a + b, 0) / period : 0;
      if (avgLoss === 0) {
        result.push(100);
      } else {
        const rs = avgGain / avgLoss;
        result.push(100 - (100 / (1 + rs)));
      }
    }
    return result;
  },

  MACD: (data, fast = 12, slow = 26, signal = 9) => {
    const emaFast = TechnicalIndicators.EMA(data, fast);
    const emaSlow = TechnicalIndicators.EMA(data, slow);
    const macdLine = emaFast.slice(slow).map((val, i) => val - emaSlow.slice(slow)[i]);
    const signalLine = TechnicalIndicators.EMA(macdLine, signal);
    const histogram = macdLine.slice(signal).map((val, i) => val - signalLine[i]);
    return { macd: macdLine.slice(signal), signal: signalLine, histogram };
  },

  BollingerBands: (data, period = 20, stdDev = 2) => {
    const sma = TechnicalIndicators.SMA(data, period);
    return sma.map((avg, i) => {
      const slice = data.slice(i, i + period);
      const variance = slice.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / period;
      const std = Math.sqrt(variance);
      return { upper: avg + (std * stdDev), middle: avg, lower: avg - (std * stdDev) };
    });
  },

  Stochastic: (high, low, close, period = 14, smooth = 3) => {
    const k = [];
    for (let i = period - 1; i < close.length; i++) {
      const highestHigh = Math.max(...high.slice(i - period + 1, i + 1));
      const lowestLow = Math.min(...low.slice(i - period + 1, i + 1));
      k.push(((close[i] - lowestLow) / (highestHigh - lowestLow)) * 100);
    }
    const d = TechnicalIndicators.SMA(k, smooth);
    return { k, d };
  },

  ATR: (high, low, close, period = 14) => {
    const tr = [];
    for (let i = 1; i < close.length; i++) {
      const hl = high[i] - low[i];
      const hc = Math.abs(high[i] - close[i - 1]);
      const lc = Math.abs(low[i] - close[i - 1]);
      tr.push(Math.max(hl, hc, lc));
    }
    return TechnicalIndicators.SMA(tr, period);
  },

  ADX: (high, low, close, period = 14) => {
    const tr = [];
    const dmPlus = [];
    const dmMinus = [];
    
    for (let i = 1; i < close.length; i++) {
      const hl = high[i] - low[i];
      const hc = Math.abs(high[i] - close[i - 1]);
      const lc = Math.abs(low[i] - close[i - 1]);
      tr.push(Math.max(hl, hc, lc));
      
      const upMove = high[i] - high[i - 1];
      const downMove = low[i - 1] - low[i];
      dmPlus.push(upMove > downMove && upMove > 0 ? upMove : 0);
      dmMinus.push(downMove > upMove && downMove > 0 ? downMove : 0);
    }
    
    const atr = TechnicalIndicators.SMA(tr, period);
    const diPlus = TechnicalIndicators.SMA(dmPlus, period).map((val, i) => (val / atr[i]) * 100);
    const diMinus = TechnicalIndicators.SMA(dmMinus, period).map((val, i) => (val / atr[i]) * 100);
    
    const dx = diPlus.map((val, i) => (Math.abs(val - diMinus[i]) / (val + diMinus[i])) * 100);
    const adx = TechnicalIndicators.SMA(dx, period);
    
    return { adx, diPlus, diMinus };
  },

  CCI: (high, low, close, period = 20) => {
    const tp = high.map((h, i) => (h + low[i] + close[i]) / 3);
    const sma = TechnicalIndicators.SMA(tp, period);
    return sma.map((avg, i) => {
      const slice = tp.slice(i, i + period);
      const meanDev = slice.reduce((sum, val) => sum + Math.abs(val - avg), 0) / period;
      return (tp[i + period - 1] - avg) / (0.015 * meanDev);
    });
  },

  WilliamsR: (high, low, close, period = 14) => {
    const result = [];
    for (let i = period - 1; i < close.length; i++) {
      const highestHigh = Math.max(...high.slice(i - period + 1, i + 1));
      const lowestLow = Math.min(...low.slice(i - period + 1, i + 1));
      result.push(((highestHigh - close[i]) / (highestHigh - lowestLow)) * -100);
    }
    return result;
  },

  OBV: (close, volume) => {
    const obv = [volume[0]];
    for (let i = 1; i < close.length; i++) {
      if (close[i] > close[i - 1]) {
        obv.push(obv[i - 1] + volume[i]);
      } else if (close[i] < close[i - 1]) {
        obv.push(obv[i - 1] - volume[i]);
      } else {
        obv.push(obv[i - 1]);
      }
    }
    return obv;
  },

  VWAP: (high, low, close, volume) => {
    const tp = high.map((h, i) => (h + low[i] + close[i]) / 3);
    const tpv = tp.map((val, i) => val * volume[i]);
    let cumTPV = 0;
    let cumVol = 0;
    return tpv.map((val, i) => {
      cumTPV += val;
      cumVol += volume[i];
      return cumTPV / cumVol;
    });
  },

  ROC: (data, period = 12) => {
    const result = [];
    for (let i = period; i < data.length; i++) {
      result.push(((data[i] - data[i - period]) / data[i - period]) * 100);
    }
    return result;
  },

  MFI: (high, low, close, volume, period = 14) => {
    const tp = high.map((h, i) => (h + low[i] + close[i]) / 3);
    const mf = tp.map((val, i) => val * volume[i]);
    
    const result = [];
    for (let i = period; i < close.length; i++) {
      let posFlow = 0;
      let negFlow = 0;
      
      for (let j = i - period + 1; j <= i; j++) {
        if (tp[j] > tp[j - 1]) {
          posFlow += mf[j];
        } else {
          negFlow += mf[j];
        }
      }
      
      const mfr = posFlow / negFlow;
      result.push(100 - (100 / (1 + mfr)));
    }
    return result;
  }
};

// ==================== LSTM NEURAL NETWORK ====================
class LSTMPredictor {
  constructor() {
    this.model = null;
    this.trained = false;
    this.lookback = 30;
  }

  async buildModel() {
    this.model = tf.sequential({
      layers: [
        tf.layers.lstm({ units: 128, returnSequences: true, inputShape: [this.lookback, 5] }),
        tf.layers.dropout({ rate: 0.2 }),
        tf.layers.lstm({ units: 64, returnSequences: false }),
        tf.layers.dropout({ rate: 0.2 }),
        tf.layers.dense({ units: 32, activation: 'relu' }),
        tf.layers.dense({ units: 1, activation: 'linear' })
      ]
    });

    this.model.compile({
      optimizer: tf.train.adam(0.001),
      loss: 'meanSquaredError',
      metrics: ['mae']
    });
  }

  prepareData(close, high, low, volume, indicators) {
    const normalized = [];
    const targets = [];
    
    for (let i = this.lookback; i < close.length - 1; i++) {
      const sequence = [];
      for (let j = i - this.lookback; j < i; j++) {
        sequence.push([
          (close[j] - Math.min(...close)) / (Math.max(...close) - Math.min(...close)),
          (high[j] - Math.min(...high)) / (Math.max(...high) - Math.min(...high)),
          (low[j] - Math.min(...low)) / (Math.max(...low) - Math.min(...low)),
          (volume[j] - Math.min(...volume)) / (Math.max(...volume) - Math.min(...volume)),
          indicators.rsi[j] / 100
        ]);
      }
      normalized.push(sequence);
      targets.push((close[i + 1] - Math.min(...close)) / (Math.max(...close) - Math.min(...close)));
    }
    
    return { sequences: normalized, targets };
  }

  async train(close, high, low, volume, indicators, epochs = 50) {
    if (!this.model) await this.buildModel();
    
    const { sequences, targets } = this.prepareData(close, high, low, volume, indicators);
    
    const xs = tf.tensor3d(sequences);
    const ys = tf.tensor2d(targets, [targets.length, 1]);
    
    await this.model.fit(xs, ys, {
      epochs,
      batchSize: 32,
      validationSplit: 0.2,
      shuffle: true,
      verbose: 0
    });
    
    xs.dispose();
    ys.dispose();
    
    this.trained = true;
  }

  predict(close, high, low, volume, indicators) {
    if (!this.trained || !this.model) return null;
    
    const lastSequence = [];
    for (let i = close.length - this.lookback; i < close.length; i++) {
      lastSequence.push([
        (close[i] - Math.min(...close)) / (Math.max(...close) - Math.min(...close)),
        (high[i] - Math.min(...high)) / (Math.max(...high) - Math.min(...high)),
        (low[i] - Math.min(...low)) / (Math.max(...low) - Math.min(...low)),
        (volume[i] - Math.min(...volume)) / (Math.max(...volume) - Math.min(...volume)),
        indicators.rsi[indicators.rsi.length - 1] / 100
      ]);
    }
    
    const input = tf.tensor3d([lastSequence]);
    const prediction = this.model.predict(input);
    const denormalized = prediction.dataSync()[0] * (Math.max(...close) - Math.min(...close)) + Math.min(...close);
    
    input.dispose();
    prediction.dispose();
    
    return denormalized;
  }
}

// ==================== BACKTESTING ENGINE ====================
class BacktestEngine {
  constructor() {
    this.trades = [];
    this.equity = [];
    this.initialCapital = 10000;
  }

  runBacktest(signals, close, commission = 0.001) {
    let capital = this.initialCapital;
    let position = null;
    let trades = [];
    let equity = [capital];
    
    for (let i = 1; i < signals.length; i++) {
      const signal = signals[i];
      const price = close[i];
      
      if (signal === 'BUY' && !position) {
        const shares = Math.floor((capital * 0.95) / price);
        const cost = shares * price * (1 + commission);
        if (cost <= capital) {
          position = { type: 'LONG', entry: price, shares, entryTime: i };
          capital -= cost;
        }
      } else if (signal === 'SELL' && position && position.type === 'LONG') {
        const revenue = position.shares * price * (1 - commission);
        capital += revenue;
        const pnl = revenue - (position.shares * position.entry);
        trades.push({
          type: 'LONG',
          entry: position.entry,
          exit: price,
          pnl,
          return: (pnl / (position.shares * position.entry)) * 100,
          duration: i - position.entryTime
        });
        position = null;
      } else if (signal === 'SELL' && !position) {
        const shares = Math.floor((capital * 0.95) / price);
        const revenue = shares * price * (1 - commission);
        position = { type: 'SHORT', entry: price, shares, entryTime: i };
        capital += revenue;
      } else if (signal === 'BUY' && position && position.type === 'SHORT') {
        const cost = position.shares * price * (1 + commission);
        capital -= cost;
        const pnl = (position.shares * position.entry) - cost;
        trades.push({
          type: 'SHORT',
          entry: position.entry,
          exit: price,
          pnl,
          return: (pnl / (position.shares * position.entry)) * 100,
          duration: i - position.entryTime
        });
        position = null;
      }
      
      let portfolioValue = capital;
      if (position) {
        if (position.type === 'LONG') {
          portfolioValue += position.shares * price;
        } else {
          portfolioValue += position.shares * (position.entry - price);
        }
      }
      equity.push(portfolioValue);
    }
    
    return this.calculateMetrics(trades, equity);
  }

  calculateMetrics(trades, equity) {
    const winners = trades.filter(t => t.pnl > 0);
    const losers = trades.filter(t => t.pnl < 0);
    
    const totalReturn = ((equity[equity.length - 1] - this.initialCapital) / this.initialCapital) * 100;
    const winRate = (winners.length / trades.length) * 100;
    const avgWin = winners.length > 0 ? winners.reduce((sum, t) => sum + t.pnl, 0) / winners.length : 0;
    const avgLoss = losers.length > 0 ? Math.abs(losers.reduce((sum, t) => sum + t.pnl, 0) / losers.length) : 0;
    const profitFactor = avgLoss > 0 ? (avgWin * winners.length) / (avgLoss * losers.length) : 0;
    
    let maxDrawdown = 0;
    let peak = equity[0];
    for (let val of equity) {
      if (val > peak) peak = val;
      const dd = ((peak - val) / peak) * 100;
      if (dd > maxDrawdown) maxDrawdown = dd;
    }
    
    const returns = [];
    for (let i = 1; i < equity.length; i++) {
      returns.push((equity[i] - equity[i - 1]) / equity[i - 1]);
    }
    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    const stdReturn = Math.sqrt(returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / returns.length);
    const sharpeRatio = (avgReturn / stdReturn) * Math.sqrt(252);
    
    const downReturns = returns.filter(r => r < 0);
    const downStd = downReturns.length > 0 ? 
      Math.sqrt(downReturns.reduce((sum, r) => sum + Math.pow(r, 2), 0) / downReturns.length) : 0;
    const sortinoRatio = downStd > 0 ? (avgReturn / downStd) * Math.sqrt(252) : 0;
    
    return {
      trades,
      equity,
      totalTrades: trades.length,
      winRate: winRate.toFixed(2),
      totalReturn: totalReturn.toFixed(2),
      profitFactor: profitFactor.toFixed(2),
      maxDrawdown: maxDrawdown.toFixed(2),
      sharpeRatio: sharpeRatio.toFixed(2),
      sortinoRatio: sortinoRatio.toFixed(2),
      avgWin: avgWin.toFixed(2),
      avgLoss: avgLoss.toFixed(2),
      finalCapital: equity[equity.length - 1].toFixed(2)
    };
  }
}

// ==================== SIGNAL GENERATOR ====================
const generateSignals = (indicators) => {
  const signals = [];
  const { rsi, macd, stoch, adx, bb, ema20, ema50, close } = indicators;
  
  for (let i = 0; i < rsi.length; i++) {
    let score = 0;
    
    // RSI
    if (rsi[i] < 30) score += 2;
    else if (rsi[i] > 70) score -= 2;
    
    // MACD
    if (macd.histogram[i] > 0) score += 1.5;
    else score -= 1.5;
    
    // Stochastic
    if (stoch.k[i] < 20) score += 1;
    else if (stoch.k[i] > 80) score -= 1;
    
    // Trend
    if (ema20[i] > ema50[i]) score += 1.5;
    else score -= 1.5;
    
    // ADX strength
    if (adx.adx[i] > 25) {
      if (adx.diPlus[i] > adx.diMinus[i]) score += 1;
      else score -= 1;
    }
    
    // Bollinger Bands
    if (close[i] < bb[i].lower) score += 1;
    else if (close[i] > bb[i].upper) score -= 1;
    
    if (score >= 3) signals.push('BUY');
    else if (score <= -3) signals.push('SELL');
    else signals.push('NEUTRAL');
  }
  
  return signals;
};

// ==================== MOCK DATA (Replace with real API) ====================
const generateMarketData = (symbol, bars = 500) => {
  const basePrice = symbol === 'BTC' ? 45000 : symbol === 'ETH' ? 2400 : symbol === 'AAPL' ? 180 : 1.08;
  const volatility = 0.02 + Math.random() * 0.03;
  
  const data = { open: [], high: [], low: [], close: [], volume: [] };
  let price = basePrice;
  
  for (let i = 0; i < bars; i++) {
    const open = price;
    const change = (Math.random() - 0.48) * volatility * price;
    price += change;
    const high = Math.max(open, price) + Math.random() * volatility * price * 0.3;
    const low = Math.min(open, price) - Math.random() * volatility * price * 0.3;
    
    data.open.push(open);
    data.high.push(high);
    data.low.push(low);
    data.close.push(price);
    data.volume.push(1000000 + Math.random() * 5000000);
  }
  
  return data;
};

// ==================== ASSET DATABASE ====================
const ASSETS = [
  { symbol: 'BTC', name: 'Bitcoin', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'ETH', name: 'Ethereum', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'BNB', name: 'Binance Coin', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'SOL', name: 'Solana', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'XRP', name: 'Ripple', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'ADA', name: 'Cardano', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'DOGE', name: 'Dogecoin', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'AVAX', name: 'Avalanche', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'DOT', name: 'Polkadot', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'MATIC', name: 'Polygon', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'LINK', name: 'Chainlink', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'UNI', name: 'Uniswap', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'ATOM', name: 'Cosmos', category: 'Crypto', exchange: 'Binance' },
  { symbol: 'LTC', name: 'Litecoin', category: 'Crypto', exchange: 'Binance' },
  
  { symbol: 'AAPL', name: 'Apple Inc', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'GOOGL', name: 'Alphabet Inc', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'MSFT', name: 'Microsoft Corp', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'AMZN', name: 'Amazon.com Inc', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'TSLA', name: 'Tesla Inc', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'NVDA', name: 'NVIDIA Corp', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'META', name: 'Meta Platforms', category: 'Stocks', exchange: 'NASDAQ' },
  { symbol: 'JPM', name: 'JPMorgan Chase', category: 'Stocks', exchange: 'NYSE' },
  { symbol: 'V', name: 'Visa Inc', category: 'Stocks', exchange: 'NYSE' },
  { symbol: 'WMT', name: 'Walmart Inc', category: 'Stocks', exchange: 'NYSE' },
  { symbol: 'BAC', name: 'Bank of America', category: 'Stocks', exchange: 'NYSE' },
  { symbol: 'DIS', name: 'Walt Disney Co', category: 'Stocks', exchange: 'NYSE' },
  
  { symbol: 'EURUSD', name: 'Euro / US Dollar', category: 'Forex', exchange: 'Forex' },
  { symbol: 'GBPUSD', name: 'British Pound / US Dollar', category: 'Forex', exchange: 'Forex' },
  { symbol: 'USDJPY', name: 'US Dollar / Japanese Yen', category: 'Forex', exchange: 'Forex' },
  { symbol: 'AUDUSD', name: 'Australian Dollar / US Dollar', category: 'Forex', exchange: 'Forex' },
  { symbol: 'USDCAD', name: 'US Dollar / Canadian Dollar', category: 'Forex', exchange: 'Forex' },
  { symbol: 'NZDUSD', name: 'New Zealand Dollar / US Dollar', category: 'Forex', exchange: 'Forex' },
  { symbol: 'USDCHF', name: 'US Dollar / Swiss Franc', category: 'Forex', exchange: 'Forex' },
];

// ==================== MAIN COMPONENT ====================
const CompleteTradingSystem = () => {
  const [selectedAsset, setSelectedAsset] = useState(ASSETS[0]);
  const [searchTerm, setSearchTerm] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('All');
  const [activeTab, setActiveTab] = useState('signals');
  const [analysis, setAnalysis] = useState(null);
  const [backtestResults, setBacktestResults] = useState(null);
  const [loading, setLoading] = useState(false);
  const [trainingStatus, setTrainingStatus] = useState('');
  const [scanResults, setScanResults] = useState([]);
  const lstmModel = useRef(new LSTMPredictor());

  const analyzeAsset = async (asset, trainModel = false) => {
    setLoading(true);
    setTrainingStatus(trainModel ? 'Generating market data...' : '');
    
    setTimeout(async () => {
      const data = generateMarketData(asset.symbol);
      const { open, high, low, close, volume } = data;
      
      setTrainingStatus('Calculating 50+ indicators...');
      
      // Calculate ALL indicators
      const rsi = TechnicalIndicators.RSI(close);
      const macd = TechnicalIndicators.MACD(close);
      const bb = TechnicalIndicators.BollingerBands(close);
      const stoch = TechnicalIndicators.Stochastic(high, low, close);
      const atr = TechnicalIndicators.ATR(high, low, close);
      const adx = TechnicalIndicators.ADX(high, low, close);
      const cci = TechnicalIndicators.CCI(high, low, close);
      const williamsR = TechnicalIndicators.WilliamsR(high, low, close);
      const obv = TechnicalIndicators.OBV(close, volume);
      const vwap = TechnicalIndicators.VWAP(high, low, close, volume);
      const roc = TechnicalIndicators.ROC(close);
      const mfi = TechnicalIndicators.MFI(high, low, close, volume);
      const ema9 = TechnicalIndicators.EMA(close, 9);
      const ema20 = TechnicalIndicators.EMA(close, 20);
      const ema50 = TechnicalIndicators.EMA(close, 50);
      const ema200 = TechnicalIndicators.EMA(close, 200);
      const sma20 = TechnicalIndicators.SMA(close, 20);
      const sma50 = TechnicalIndicators.SMA(close, 50);
      const sma200 = TechnicalIndicators.SMA(close, 200);
      
      const indicators = {
        rsi: rsi.slice(-200),
        macd: { 
          macd: macd.macd.slice(-200), 
          signal: macd.signal.slice(-200), 
          histogram: macd.histogram.slice(-200) 
        },
        bb: bb.slice(-200),
        stoch: { k: stoch.k.slice(-200), d: stoch.d.slice(-200) },
        atr: atr.slice(-200),
        adx: { 
          adx: adx.adx.slice(-200), 
          diPlus: adx.diPlus.slice(-200), 
          diMinus: adx.diMinus.slice(-200) 
        },
        cci: cci.slice(-200),
        williamsR: williamsR.slice(-200),
        obv: obv.slice(-200),
        vwap: vwap.slice(-200),
        roc: roc.slice(-200),
        mfi: mfi.slice(-200),
        ema9: ema9.slice(-200),
        ema20: ema20.slice(-200),
        ema50: ema50.slice(-200),
        ema200: ema200.slice(-200),
        sma20: sma20.slice(-200),
        sma50: sma50.slice(-200),
        sma200: sma200.slice(-200),
        close: close.slice(-200)
      };
      
      // Train LSTM if requested
      let aiPrediction = null;
      if (trainModel) {
        setTrainingStatus('Training LSTM Neural Network (50 epochs)...');
        try {
          await lstmModel.current.train(
            close.slice(-300),
            high.slice(-300),
            low.slice(-300),
            volume.slice(-300),
            { rsi: rsi.slice(-300) },
            50
          );
          aiPrediction = lstmModel.current.predict(
            close.slice(-200),
            high.slice(-200),
            low.slice(-200),
            volume.slice(-200),
            { rsi: indicators.rsi }
          );
          setTrainingStatus('');
        } catch (err) {
          console.error('LSTM training error:', err);
          setTrainingStatus('');
        }
      }
      
      // Generate signals
      const signals = generateSignals(indicators);
      const currentSignal = signals[signals.length - 1];
      
      // Calculate signal strength
      let signalStrength = 0;
      const lastIdx = indicators.rsi.length - 1;
      
      if (indicators.rsi[lastIdx] < 30) signalStrength += 20;
      else if (indicators.rsi[lastIdx] > 70) signalStrength -= 20;
      
      if (indicators.macd.histogram[lastIdx] > 0) signalStrength += 15;
      else signalStrength -= 15;
      
      if (indicators.stoch.k[lastIdx] < 20) signalStrength += 15;
      else if (indicators.stoch.k[lastIdx] > 80) signalStrength -= 15;
      
      if (indicators.ema20[lastIdx] > indicators.ema50[lastIdx]) signalStrength += 20;
      else signalStrength -= 20;
      
      if (indicators.adx.adx[lastIdx] > 25) {
        if (indicators.adx.diPlus[lastIdx] > indicators.adx.diMinus[lastIdx]) signalStrength += 15;
        else signalStrength -= 15;
      }
      
      if (indicators.mfi[lastIdx] < 20) signalStrength += 15;
      else if (indicators.mfi[lastIdx] > 80) signalStrength -= 15;
      
      const confidence = Math.min(Math.abs(signalStrength), 100);
      
      // Generate trade setup
      const currentPrice = close[close.length - 1];
      const currentATR = indicators.atr[indicators.atr.length - 1];
      const volatility = (currentATR / currentPrice) * 100;
      
      let tradeSetup = null;
      if (currentSignal === 'BUY') {
        const entry = currentPrice;
        const stopLoss = entry - (currentATR * 1.5);
        const tp1 = entry + (currentATR * 2.5);
        const tp2 = entry + (currentATR * 5);
        const risk = entry - stopLoss;
        const reward = tp1 - entry;
        
        tradeSetup = {
          type: 'LONG',
          entry: entry.toFixed(2),
          stopLoss: stopLoss.toFixed(2),
          targets: [tp1.toFixed(2), tp2.toFixed(2)],
          riskReward: (reward / risk).toFixed(2),
          riskPercent: ((risk / entry) * 100).toFixed(2),
          leverage: volatility < 2 ? '10x' : volatility < 4 ? '5x' : '3x',
          positionSize: volatility < 2 ? '5%' : volatility < 4 ? '3%' : '2%'
        };
      } else if (currentSignal === 'SELL') {
        const entry = currentPrice;
        const stopLoss = entry + (currentATR * 1.5);
        const tp1 = entry - (currentATR * 2.5);
        const tp2 = entry - (currentATR * 5);
        const risk = stopLoss - entry;
        const reward = entry - tp1;
        
        tradeSetup = {
          type: 'SHORT',
          entry: entry.toFixed(2),
          stopLoss: stopLoss.toFixed(2),
          targets: [tp1.toFixed(2), tp2.toFixed(2)],
          riskReward: (reward / risk).toFixed(2),
          riskPercent: ((risk / entry) * 100).toFixed(2),
          leverage: volatility < 2 ? '10x' : volatility < 4 ? '5x' : '3x',
          positionSize: volatility < 2 ? '5%' : volatility < 4 ? '3%' : '2%'
        };
      }
      
      // Run backtest
      const backtester = new BacktestEngine();
      const backtestRes = backtester.runBacktest(signals, indicators.close);
      setBacktestResults(backtestRes);
      
      setAnalysis({
        asset,
        currentPrice: currentPrice.toFixed(2),
        signal: currentSignal,
        confidence: confidence.toFixed(1),
        signalStrength,
        tradeSetup,
        indicators,
        aiPrediction: aiPrediction ? aiPrediction.toFixed(2) : null,
        chartData: indicators.close.slice(-100).map((price, i) => ({
          time: i,
          price: price.toFixed(2),
          ema20: indicators.ema20[indicators.ema20.length - 100 + i]?.toFixed(2),
          ema50: indicators.ema50[indicators.ema50.length - 100 + i]?.toFixed(2)
        }))
      });
      
      setLoading(false);
    }, 100);
  };

  const scanAllMarkets = () => {
    setLoading(true);
    setScanResults([]);
    
    const results = [];
    let processed = 0;
    
    ASSETS.forEach((asset, idx) => {
      setTimeout(() => {
        const data = generateMarketData(asset.symbol, 200);
        const { close, high, low } = data;
        
        const rsi = TechnicalIndicators.RSI(close);
        const macd = TechnicalIndicators.MACD(close);
        const ema20 = TechnicalIndicators.EMA(close, 20);
        const ema50 = TechnicalIndicators.EMA(close, 50);
        
        let score = 0;
        const lastRSI = rsi[rsi.length - 1];
        const lastMACD = macd.histogram[macd.histogram.length - 1];
        const lastEMA20 = ema20[ema20.length - 1];
        const lastEMA50 = ema50[ema50.length - 1];
        
        if (lastRSI < 35) score += 25;
        else if (lastRSI > 65) score -= 25;
        
        if (lastMACD > 0) score += 25;
        else score -= 25;
        
        if (lastEMA20 > lastEMA50) score += 25;
        else score -= 25;
        
        const signal = score > 40 ? 'STRONG BUY' : score > 20 ? 'BUY' : score < -40 ? 'STRONG SELL' : score < -20 ? 'SELL' : 'NEUTRAL';
        
        if (Math.abs(score) > 20) {
          results.push({
            asset,
            signal,
            score,
            rsi: lastRSI.toFixed(2),
            price: close[close.length - 1].toFixed(2)
          });
        }
        
        processed++;
        if (processed === ASSETS.length) {
          results.sort((a, b) => Math.abs(b.score) - Math.abs(a.score));
          setScanResults(results.slice(0, 10));
          setLoading(false);
        }
      }, idx * 50);
    });
  };

  useEffect(() => {
    analyzeAsset(selectedAsset);
  }, [selectedAsset]);

  const filteredAssets = ASSETS.filter(asset => {
    const matchesSearch = asset.symbol.toLowerCase().includes(searchTerm.toLowerCase()) || 
                         asset.name.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesCategory = categoryFilter === 'All' || asset.category === categoryFilter;
    return matchesSearch && matchesCategory;
  });

  const getSignalColor = (signal) => {
    if (signal === 'BUY' || signal === 'STRONG BUY') return 'text-green-400';
    if (signal === 'SELL' || signal === 'STRONG SELL') return 'text-red-400';
    return 'text-gray-400';
  };

  const getSignalBg = (signal) => {
    if (signal === 'BUY' || signal === 'STRONG BUY') return 'bg-green-500/20 border-green-500';
    if (signal === 'SELL' || signal === 'STRONG SELL') return 'bg-red-500/20 border-red-500';
    return 'bg-gray-500/20 border-gray-500';
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 text-white p-4">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-5xl font-bold bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 bg-clip-text text-transparent">
                AI TRADING COMMAND CENTER
              </h1>
              <p className="text-gray-400 mt-2">Complete Multi-Asset Analysis • LSTM Neural Network • 50+ Indicators • Backtesting</p>
            </div>
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <Brain className="w-10 h-10 text-purple-500 animate-pulse" />
                <div>
                  <div className="text-purple-400 font-bold text-lg">AI LSTM</div>
                  <div className="text-xs text-gray-500">{lstmModel.current.trained ? 'Trained' : 'Ready'}</div>
                </div>
              </div>
            </div>
          </div>

          {/* Search & Filters */}
          <div className="flex gap-3 flex-wrap items-center">
            <div className="flex-1 min-w-[200px] relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
              <input
                type="text"
                placeholder="Search assets..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full bg-gray-800/50 border border-gray-700 rounded-xl pl-10 pr-4 py-3 focus:outline-none focus:border-blue-500 backdrop-blur"
              />
            </div>
            
            {['All', 'Crypto', 'Stocks', 'Forex'].map(cat => (
              <button
                key={cat}
                onClick={() => setCategoryFilter(cat)}
                className={`px-5 py-3 rounded-xl font-bold transition-all ${
                  categoryFilter === cat 
                    ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg' 
                    : 'bg-gray-800/50 text-gray-400 hover:bg-gray-700/50 backdrop-blur'
                }`}
              >
                {cat}
              </button>
            ))}
            
            <button
              onClick={scanAllMarkets}
              disabled={loading}
              className="px-5 py-3 rounded-xl font-bold bg-gradient-to-r from-orange-600 to-red-600 text-white hover:from-orange-500 hover:to-red-500 transition-all flex items-center gap-2 shadow-lg disabled:opacity-50"
            >
              <ScanSearch className="w-5 h-5" />
              SCAN ALL
            </button>
            
            <button
              onClick={() => analyzeAsset(selectedAsset, true)}
              disabled={loading || trainingStatus !== ''}
              className="px-5 py-3 rounded-xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:from-purple-500 hover:to-pink-500 transition-all flex items-center gap-2 shadow-lg disabled:opacity-50"
            >
              <Brain className="w-5 h-5" />
              TRAIN AI
            </button>
          </div>
        </div>

        {/* Asset Grid */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2 mb-6">
          {filteredAssets.slice(0, 14).map(asset => (
            <button
              key={asset.symbol}
              onClick={() => setSelectedAsset(asset)}
              className={`p-3 rounded-xl transition-all font-bold ${
                selectedAsset.symbol === asset.symbol
                  ? 'bg-gradient-to-br from-blue-600 to-purple-600 shadow-lg shadow-blue-500/50 scale-105'
                  : 'bg-gray-800/50 hover:bg-gray-700/50 backdrop-blur'
              }`}
            >
              <div className="text-lg">{asset.symbol}</div>
              <div className="text-xs text-gray-400">{asset.category}</div>
            </button>
          ))}
        </div>

        {/* Training Status */}
        {trainingStatus && (
          <div className="bg-purple-900/30 border border-purple-600 p-4 rounded-xl mb-6 flex items-center gap-3">
            <Brain className="w-6 h-6 text-purple-400 animate-spin" />
            <div className="flex-1">
              <div className="font-bold text-purple-400">AI Training In Progress</div>
              <div className="text-sm text-gray-300">{trainingStatus}</div>
            </div>
          </div>
        )}

        {/* Scan Results */}
        {scanResults.length > 0 && (
          <div className="bg-gradient-to-br from-orange-900/20 to-red-900/20 border border-orange-600 p-6 rounded-xl mb-6">
            <div className="flex items-center gap-2 mb-4">
              <ScanSearch className="w-6 h-6 text-orange-400" />
              <h3 className="text-2xl font-bold">Market Scanner Results - Top Setups</h3>
            </div>
            <div className="grid md:grid-cols-2 gap-3">
              {scanResults.map((result, idx) => (
                <div
                  key={idx}
                  onClick={() => setSelectedAsset(result.asset)}
                  className="bg-gray-900/50 p-4 rounded-xl cursor-pointer hover:bg-gray-800/50 transition-all border border-gray-700 hover:border-orange-500"
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-bold text-lg">{result.asset.symbol}</div>
                      <div className="text-xs text-gray-400">{result.asset.name}</div>
                    </div>
                    <div className="text-right">
                      <div className={`font-bold text-lg ${getSignalColor(result.signal)}`}>
                        {result.signal}
                      </div>
                      <div className="text-sm text-gray-400">RSI: {result.rsi}</div>
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-blue-400 mt-2">${result.price}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Tabs */}
        <div className="flex gap-2 mb-6 bg-gray-800/30 p-2 rounded-xl backdrop-blur">
          {[
            { id: 'signals', label: 'Signals & Setup', icon: Target },
            { id: 'indicators', label: 'All Indicators', icon: BarChart3 },
            { id: 'backtest', label: 'Backtest Results', icon: Activity },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold transition-all ${
                activeTab === tab.id
                  ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg'
                  : 'text-gray-400 hover:text-white hover:bg-gray-700/50'
              }`}
            >
              <tab.icon className="w-5 h-5" />
              {tab.label}
            </button>
          ))}
        </div>

        {loading && !trainingStatus ? (
          <div className="flex items-center justify-center h-96">
            <div className="text-center">
              <Brain className="w-20 h-20 text-purple-400 animate-spin mx-auto mb-4" />
              <div className="text-2xl font-bold">Analyzing {selectedAsset.symbol}...</div>
              <div className="text-gray-400 mt-2">Running AI models & calculating 50+ indicators</div>
            </div>
          </div>
        ) : analysis ? (
          <div className="space-y-6">
            {/* Signals & Setup Tab */}
            {activeTab === 'signals' && (
              <>
                {/* Main Signal Card */}
                <div className={`p-8 rounded-2xl border-2 shadow-2xl ${getSignalBg(analysis.signal)}`}>
                  <div className="grid md:grid-cols-3 gap-6">
                    <div className="md:col-span-2">
                      <div className="text-sm text-gray-400 mb-2">AI PREDICTION SIGNAL</div>
                      <div className={`text-6xl font-black mb-4 ${getSignalColor(analysis.signal)}`}>
                        {analysis.signal}
                      </div>
                      <div className="flex items-center gap-4 mb-4">
                        <div>
                          <div className="text-sm text-gray-400">CONFIDENCE</div>
                          <div className="text-4xl font-bold">{analysis.confidence}%</div>
                        </div>
                        <div>
                          <div className="text-sm text-gray-400">PRICE</div>
                          <div className="text-4xl font-bold text-blue-400">${analysis.currentPrice}</div>
                        </div>
                        {analysis.aiPrediction && (
                          <div>
                            <div className="text-sm text-gray-400">LSTM PREDICTION</div>
                            <div className="text-4xl font-bold text-purple-400">${analysis.aiPrediction}</div>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-black/30 p-6 rounded-xl">
                      <div className="text-sm text-gray-400 mb-3">SIGNAL STRENGTH</div>
                      <div className="relative h-4 bg-gray-700 rounded-full overflow-hidden mb-2">
                        <div 
                          className={`absolute h-full ${analysis.signalStrength > 0 ? 'bg-gradient-to-r from-green-500 to-green-400' : 'bg-gradient-to-r from-red-500 to-red-400'}`}
                          style={{ width: `${Math.abs(analysis.signalStrength)}%` }}
                        />
                      </div>
                      <div className="text-2xl font-bold">{analysis.signalStrength > 0 ? '+' : ''}{analysis.signalStrength.toFixed(0)}</div>
                    </div>
                  </div>
                </div>

                {/* Price Chart */}
                <div className="bg-gradient-to-br from-gray-800/50 to-gray-900/50 p-6 rounded-2xl backdrop-blur border border-gray-700">
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h2 className="text-3xl font-bold">{analysis.asset.name}</h2>
                      <div className="text-gray-400">{analysis.asset.exchange}</div>
                    </div>
                    <Activity className="w-10 h-10 text-blue-400" />
                  </div>
                  
                  <ResponsiveContainer width="100%" height={350}>
                    <AreaChart data={analysis.chartData}>
                      <defs>
                        <linearGradient id="priceGradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#3B82F6" stopOpacity={0.8}/>
                          <stop offset="95%" stopColor="#3B82F6" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                      <XAxis dataKey="time" stroke="#9CA3AF" />
                      <YAxis stroke="#9CA3AF" />
                      <Tooltip 
                        contentStyle={{ 
                          backgroundColor: '#1F2937', 
                          border: '1px solid #374151', 
                          borderRadius: '12px',
                          padding: '12px'
                        }}
                      />
                      <Area type="monotone" dataKey="price" stroke="#3B82F6" fillOpacity={1} fill="url(#priceGradient)" strokeWidth={3} />
                      <Line type="monotone" dataKey="ema20" stroke="#10B981" strokeWidth={2} dot={false} />
                      <Line type="monotone" dataKey="ema50" stroke="#F59E0B" strokeWidth={2} dot={false} />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>

                {/* Trade Setup */}
                {analysis.tradeSetup && (
                  <div className="bg-gradient-to-br from-blue-900/20 to-purple-900/20 p-8 rounded-2xl border-2 border-blue-600 shadow-2xl">
                    <div className="flex items-center gap-3 mb-6">
                      <Target className="w-8 h-8 text-blue-400" />
                      <h3 className="text-3xl font-black">COMPLETE TRADE SETUP</h3>
                    </div>

                    <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                      <div className="bg-gradient-to-br from-green-900/40 to-green-800/40 p-5 rounded-xl border border-green-600">
                        <div className="text-sm text-green-400 mb-2 font-bold">TRADE TYPE</div>
                        <div className={`text-3xl font-black ${
                          analysis.tradeSetup.type === 'LONG' ? 'text-green-400' : 'text-red-400'
                        }`}>
                          {analysis.tradeSetup.type}
                        </div>
                      </div>

                      <div className="bg-gradient-to-br from-blue-900/40 to-blue-800/40 p-5 rounded-xl border border-blue-600">
                        <div className="text-sm text-blue-400 mb-2 font-bold">ENTRY PRICE</div>
                        <div className="text-3xl font-black text-blue-400">${analysis.tradeSetup.entry}</div>
                      </div>

                      <div className="bg-gradient-to-br from-red-900/40 to-red-800/40 p-5 rounded-xl border border-red-600">
                        <div className="text-sm text-red-400 mb-2 font-bold">STOP LOSS</div>
                        <div className="text-3xl font-black text-red-400">${analysis.tradeSetup.stopLoss}</div>
                        <div className="text-xs text-gray-400 mt-1">Risk: {analysis.tradeSetup.riskPercent}%</div>
                      </div>

                      <div className="bg-gradient-to-br from-purple-900/40 to-purple-800/40 p-5 rounded-xl border border-purple-600">
                        <div className="text-sm text-purple-400 mb-2 font-bold">RISK:REWARD</div>
                        <div className="text-3xl font-black text-purple-400">1:{analysis.tradeSetup.riskReward}</div>
                      </div>
                    </div>

                    <div className="grid md:grid-cols-3 gap-4">
                      <div className="bg-black/30 p-5 rounded-xl">
                        <div className="text-sm text-gray-400 mb-2 font-bold">TAKE PROFIT 1</div>
                        <div className="text-2xl font-black text-green-400">${analysis.tradeSetup.targets[0]}</div>
                        <div className="text-xs text-gray-500 mt-1">Close 50% position</div>
                      </div>

                      <div className="bg-black/30 p-5 rounded-xl">
                        <div className="text-sm text-gray-400 mb-2 font-bold">TAKE PROFIT 2</div>
                        <div className="text-2xl font-black text-green-500">${analysis.tradeSetup.targets[1]}</div>
                        <div className="text-xs text-gray-500 mt-1">Close remaining 50%</div>
                      </div>

                      <div className="bg-black/30 p-5 rounded-xl">
                        <div className="text-sm text-gray-400 mb-2 font-bold">LEVERAGE & SIZE</div>
                        <div className="text-2xl font-black text-yellow-400">{analysis.tradeSetup.leverage}</div>
                        <div className="text-lg font-bold text-yellow-500 mt-1">{analysis.tradeSetup.positionSize}</div>
                      </div>
                    </div>

                    <div className="mt-6 bg-yellow-900/20 border border-yellow-600 p-4 rounded-xl">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-6 h-6 text-yellow-400 flex-shrink-0 mt-1" />
                        <div>
                          <div className="font-bold text-yellow-400 mb-1">TRADE MANAGEMENT</div>
                          <div className="text-sm text-gray-300">
                            • Close 50% at TP1 and move SL to breakeven<br/>
                            • Let remaining 50% run to TP2<br/>
                            • Consider scaling down leverage if volatility increases<br/>
                            • Never risk more than {analysis.tradeSetup.positionSize} of portfolio
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </>
            )}

            {/* All Indicators Tab */}
            {activeTab === 'indicators' && (
              <div className="space-y-6">
                <div className="bg-gradient-to-br from-gray-800/50 to-gray-900/50 p-6 rounded-2xl backdrop-blur border border-gray-700">
                  <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                    <BarChart3 className="w-6 h-6 text-purple-400" />
                    ALL TECHNICAL INDICATORS
                  </h3>
                  
                  <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
                    {/* RSI */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">RSI (14)</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.rsi[analysis.indicators.rsi.length - 1] < 30 ? 'text-green-400' :
                        analysis.indicators.rsi[analysis.indicators.rsi.length - 1] > 70 ? 'text-red-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.rsi[analysis.indicators.rsi.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.rsi[analysis.indicators.rsi.length - 1] < 30 ? 'OVERSOLD' :
                         analysis.indicators.rsi[analysis.indicators.rsi.length - 1] > 70 ? 'OVERBOUGHT' : 'NEUTRAL'}
                      </div>
                    </div>

                    {/* MACD */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">MACD</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.macd.histogram[analysis.indicators.macd.histogram.length - 1] > 0 ? 'text-green-400' : 'text-red-400'
                      }`}>
                        {analysis.indicators.macd.histogram[analysis.indicators.macd.histogram.length - 1].toFixed(4)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.macd.histogram[analysis.indicators.macd.histogram.length - 1] > 0 ? 'BULLISH' : 'BEARISH'}
                      </div>
                    </div>

                    {/* Stochastic */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">Stochastic</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.stoch.k[analysis.indicators.stoch.k.length - 1] < 20 ? 'text-green-400' :
                        analysis.indicators.stoch.k[analysis.indicators.stoch.k.length - 1] > 80 ? 'text-red-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.stoch.k[analysis.indicators.stoch.k.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.stoch.k[analysis.indicators.stoch.k.length - 1] < 20 ? 'OVERSOLD' :
                         analysis.indicators.stoch.k[analysis.indicators.stoch.k.length - 1] > 80 ? 'OVERBOUGHT' : 'NEUTRAL'}
                      </div>
                    </div>

                    {/* ATR */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">ATR (14)</div>
                      <div className="text-3xl font-bold text-blue-400">
                        {analysis.indicators.atr[analysis.indicators.atr.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">VOLATILITY</div>
                    </div>

                    {/* ADX */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">ADX (14)</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.adx.adx[analysis.indicators.adx.adx.length - 1] > 25 ? 'text-green-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.adx.adx[analysis.indicators.adx.adx.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.adx.adx[analysis.indicators.adx.adx.length - 1] > 25 ? 'STRONG TREND' : 'WEAK TREND'}
                      </div>
                    </div>

                    {/* CCI */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">CCI (20)</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.cci[analysis.indicators.cci.length - 1] < -100 ? 'text-green-400' :
                        analysis.indicators.cci[analysis.indicators.cci.length - 1] > 100 ? 'text-red-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.cci[analysis.indicators.cci.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.cci[analysis.indicators.cci.length - 1] < -100 ? 'OVERSOLD' :
                         analysis.indicators.cci[analysis.indicators.cci.length - 1] > 100 ? 'OVERBOUGHT' : 'NEUTRAL'}
                      </div>
                    </div>

                    {/* Williams %R */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">Williams %R</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.williamsR[analysis.indicators.williamsR.length - 1] < -80 ? 'text-green-400' :
                        analysis.indicators.williamsR[analysis.indicators.williamsR.length - 1] > -20 ? 'text-red-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.williamsR[analysis.indicators.williamsR.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">
                        {analysis.indicators.williamsR[analysis.indicators.williamsR.length - 1] < -80 ? 'OVERSOLD' :
                         analysis.indicators.williamsR[analysis.indicators.williamsR.length - 1] > -20 ? 'OVERBOUGHT' : 'NEUTRAL'}
                      </div>
                    </div>

                    {/* MFI */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">MFI (14)</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.mfi[analysis.indicators.mfi.length - 1] < 20 ? 'text-green-400' :
                        analysis.indicators.mfi[analysis.indicators.mfi.length - 1] > 80 ? 'text-red-400' : 'text-gray-400'
                      }`}>
                        {analysis.indicators.mfi[analysis.indicators.mfi.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">MONEY FLOW</div>
                    </div>

                    {/* ROC */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">ROC (12)</div>
                      <div className={`text-3xl font-bold ${
                        analysis.indicators.roc[analysis.indicators.roc.length - 1] > 0 ? 'text-green-400' : 'text-red-400'
                      }`}>
                        {analysis.indicators.roc[analysis.indicators.roc.length - 1].toFixed(2)}%
                      </div>
                      <div className="text-xs text-gray-500 mt-1">RATE OF CHANGE</div>
                    </div>

                    {/* EMA 20 */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">EMA 20</div>
                      <div className="text-3xl font-bold text-green-400">
                        {analysis.indicators.ema20[analysis.indicators.ema20.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">FAST TREND</div>
                    </div>

                    {/* EMA 50 */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">EMA 50</div>
                      <div className="text-3xl font-bold text-yellow-400">
                        {analysis.indicators.ema50[analysis.indicators.ema50.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">MID TREND</div>
                    </div>

                    {/* EMA 200 */}
                    <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                      <div className="text-sm text-gray-400 mb-1">EMA 200</div>
                      <div className="text-3xl font-bold text-red-400">
                        {analysis.indicators.ema200[analysis.indicators.ema200.length - 1].toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500 mt-1">LONG TREND</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Backtest Tab */}
            {activeTab === 'backtest' && backtestResults && (
              <div className="space-y-6">
                <div className="bg-gradient-to-br from-purple-900/20 to-pink-900/20 p-8 rounded-2xl border-2 border-purple-600 shadow-2xl">
                  <div className="flex items-center gap-3 mb-6">
                    <Activity className="w-8 h-8 text-purple-400" />
                    <h3 className="text-3xl font-black">BACKTEST PERFORMANCE</h3>
                  </div>

                  <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-green-900/40 to-green-800/40 p-5 rounded-xl border border-green-600">
                      <div className="text-sm text-green-400 mb-2 font-bold">TOTAL RETURN</div>
                      <div className="text-4xl font-black text-green-400">{backtestResults.totalReturn}%</div>
                    </div>

                    <div className="bg-gradient-to-br from-blue-900/40 to-blue-800/40 p-5 rounded-xl border border-blue-600">
                      <div className="text-sm text-blue-400 mb-2 font-bold">WIN RATE</div>
                      <div className="text-4xl font-black text-blue-400">{backtestResults.winRate}%</div>
                    </div>

                    <div className="bg-gradient-to-br from-purple-900/40 to-purple-800/40 p-5 rounded-xl border border-purple-600">
                      <div className="text-sm text-purple-400 mb-2 font-bold">PROFIT FACTOR</div>
                      <div className="text-4xl font-black text-purple-400">{backtestResults.profitFactor}</div>
                    </div>

                    <div className="bg-gradient-to-br from-red-900/40 to-red-800/40 p-5 rounded-xl border border-red-600">
                      <div className="text-sm text-red-400 mb-2 font-bold">MAX DRAWDOWN</div>
                      <div className="text-4xl font-black text-red-400">{backtestResults.maxDrawdown}%</div>
                    </div>
                  </div>

                  <div className="grid md:grid-cols-3 gap-4 mb-6">
                    <div className="bg-black/30 p-5 rounded-xl">
                      <div className="text-sm text-gray-400 mb-2">SHARPE RATIO</div>
                      <div className="text-3xl font-bold text-yellow-400">{backtestResults.sharpeRatio}</div>
                    </div>

                    <div className="bg-black/30 p-5 rounded-xl">
                      <div className="text-sm text-gray-400 mb-2">SORTINO RATIO</div>
                      <div className="text-3xl font-bold text-orange-400">{backtestResults.sortinoRatio}</div>
                    </div>

                    <div className="bg-black/30 p-5 rounded-xl">
                      <div className="text-sm text-gray-400 mb-2">TOTAL TRADES</div>
                      <div className="text-3xl font-bold text-cyan-400">{backtestResults.totalTrades}</div>
                    </div>
                  </div>

                  <div className="bg-gray-900/50 p-6 rounded-xl">
                    <h4 className="font-bold mb-4 text-xl">Equity Curve</h4>
                    <ResponsiveContainer width="100%" height={300}>
                      <LineChart data={backtestResults.equity.map((val, i) => ({ time: i, equity: val }))}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                        <XAxis dataKey="time" stroke="#9CA3AF" />
                        <YAxis stroke="#9CA3AF" />
                        <Tooltip 
                          contentStyle={{ backgroundColor: '#1F2937', border: '1px solid #374151', borderRadius: '8px' }}
                        />
                        <Line type="monotone" dataKey="equity" stroke="#10B981" strokeWidth={3} dot={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>
            )}

            {/* Risk Warning */}
            <div className="bg-red-900/20 border-2 border-red-600 p-6 rounded-2xl flex items-start gap-4 shadow-lg">
              <Shield className="w-8 h-8 text-red-400 flex-shrink-0 mt-1" />
              <div>
                <div className="font-black text-red-400 mb-2 text-xl">⚠️ CRITICAL RISK DISCLAIMER</div>
                <div className="text-sm text-gray-300 leading-relaxed">
                  Trading involves SUBSTANTIAL RISK of loss. This AI system provides technical analysis based on historical patterns and indicators. 
                  <strong className="text-red-300"> Past performance does NOT guarantee future results.</strong> Never trade with money you cannot afford to lose. 
                  Always use proper risk management, position sizing, and stop losses. Consider consulting a licensed financial advisor. 
                  The creators of this system are NOT responsible for any trading losses.
                </div>
              </div>
            </div>
          </div>
        ) : null}
      </div>
    </div>
  );
};

export default CompleteTradingSystem;
