<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>⚡ Quantum Terminal - Ultimate Trading Platform</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --border: rgba(148, 163, 184, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Mobile First Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 1920px;
            margin: 0 auto;
        }
        
        .logo {
            font-size: 18px;
            font-weight: 900;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            color: var(--text-primary);
            padding: 10px 16px 10px 40px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }
        
        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s;
        }
        
        .search-results.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .search-item {
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .search-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .price-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }
        
        .price-main {
            font-size: 18px;
            font-weight: 800;
            white-space: nowrap;
        }
        
        .price-change {
            font-size: 12px;
            font-weight: 700;
        }
        
        .up { color: var(--success); }
        .down { color: var(--danger); }
        
        .mobile-menu-btn {
            display: none;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Timeframe Selector */
        .tf-selector {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .tf-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tf-btn:hover, .tf-btn.active {
            background: var(--accent);
            color: white;
        }
        
        /* Signal Card */
        .signal-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.05));
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .signal-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .signal-strong-buy { background: linear-gradient(135deg, #10b981, #059669); }
        .signal-buy { background: linear-gradient(135deg, #34d399, #10b981); }
        .signal-hold { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .signal-sell { background: linear-gradient(135deg, #f87171, #ef4444); }
        .signal-strong-sell { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .confidence-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            height: 500px;
            position: relative;
        }
        
        #chartElement {
            width: 100%;
            height: 100%;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab:hover, .tab.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--text-primary);
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .indicator-item {
            background: var(--bg-tertiary);
            border-left: 3px solid transparent;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        
        .indicator-item.bullish { border-left-color: var(--success); }
        .indicator-item.bearish { border-left-color: var(--danger); }
        .indicator-item.neutral { border-left-color: var(--text-secondary); }
        
        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .indicator-name {
            font-weight: 700;
            font-size: 13px;
        }
        
        .indicator-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
        }
        
        .badge-buy { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-sell { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }
        
        .indicator-value {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .metric-box {
            background: var(--bg-tertiary);
            padding: 14px;
            border-radius: 12px;
            transition: transform 0.2s;
        }
        
        .metric-box:hover {
            transform: translateY(-2px);
        }
        
        .metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: 800;
        }
        
        /* Market List */
        .market-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .market-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(4px);
        }
        
        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .market-symbol {
            font-weight: 800;
            font-size: 14px;
        }
        
        .market-price {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .market-change {
            font-size: 13px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 10001;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 90vw;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notif-title {
            font-weight: 800;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .notif-body {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.5);
        }
        
        /* Desktop Layout */
        @media (min-width: 1024px) {
            .main-content {
                grid-template-columns: 300px 1fr 360px;
                grid-template-rows: auto 1fr;
            }
            
            .mobile-menu-btn {
                display: none !important;
            }
            
            .tf-selector {
                grid-column: 2;
            }
            
            .left-panel {
                grid-column: 1;
                grid-row: 1 / -1;
            }
            
            .center-panel {
                grid-column: 2;
                grid-row: 2;
            }
            
            .right-panel {
                grid-column: 3;
                grid-row: 1 / -1;
            }
            
            .chart-container {
                height: calc(100vh - 220px);
            }
        }
        
        /* Tablet */
        @media (min-width: 768px) and (max-width: 1023px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
            
            .tf-selector {
                grid-column: 1 / -1;
            }
            
            .chart-container {
                grid-column: 1 / -1;
                height: 450px;
            }
        }
        
        /* Mobile */
        @media (max-width: 767px) {
            .header-content {
                gap: 8px;
            }
            
            .logo {
                font-size: 14px;
            }
            
            .search-wrapper {
                max-width: none;
            }
            
            .price-display {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .chart-container {
                height: 350px;
            }
            
            .signal-badge {
                font-size: 16px;
                padding: 10px 16px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    
    <div id="notificationArea"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Initializing...</div>
    </div>
    
    <div class="app-container">
        
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo">⚡ QUANTUM</div>
                
                <div class="search-wrapper">
                    <span class="search-icon">🔍</span>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="Search markets..."
                        autocomplete="off"
                    />
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <div class="price-display">
                    <div class="price-main" id="currentPrice">--</div>
                    <div class="price-change up" id="priceChange">+0.00%</div>
                </div>
                
                <button class="mobile-menu-btn" id="menuBtn">☰</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Timeframe Selector -->
            <div class="tf-selector">
                <button class="tf-btn" data-tf="1">1m</button>
                <button class="tf-btn" data-tf="3">3m</button>
                <button class="tf-btn" data-tf="5">5m</button>
                <button class="tf-btn" data-tf="15">15m</button>
                <button class="tf-btn" data-tf="30">30m</button>
                <button class="tf-btn" data-tf="60">1H</button>
                <button class="tf-btn" data-tf="240">4H</button>
                <button class="tf-btn active" data-tf="D">1D</button>
                <button class="tf-btn" data-tf="W">1W</button>
                <button class="tf-btn" data-tf="M">1M</button>
            </div>
            
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="card">
                    <div class="card-title">📊 Markets</div>
                    <div id="marketsList"></div>
                </div>
            </div>
            
            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Signal -->
                <div class="signal-card">
                    <div class="signal-badge signal-hold" id="signalBadge">
                        <span id="signalEmoji">⏸️</span>
                        <span id="signalText">ANALYZING</span>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                        Confidence: <span id="confidenceText" style="font-weight: 700;">--%</span>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Chart -->
                <div class="chart-container">
                    <div id="chartElement"></div>
                </div>
                
                <!-- Metrics -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-title">📈 Performance</div>
                    <div class="metrics-grid" id="metricsGrid"></div>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="right-panel">
                <div class="card">
                    <div class="tabs">
                        <button class="tab active" data-tab="indicators">Indicators</button>
                        <button class="tab" data-tab="ai">AI Models</button>
                        <button class="tab" data-tab="patterns">Patterns</button>
                    </div>
                    
                    <div id="indicatorsTab" class="tab-panel active">
                        <div id="indicatorsList"></div>
                    </div>
                    
                    <div id="aiTab" class="tab-panel">
                        <div id="aiContent"></div>
                    </div>
                    
                    <div id="patternsTab" class="tab-panel">
                        <div id="patternsContent"></div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>

    <script>
        // State
        const APP = {
            chart: null,
            candleSeries: null,
            volumeSeries: null,
            symbol: 'BTCUSDT',
            timeframe: 'D',
            data: null,
            indicators: {},
            allSymbols: [],
            symbolsLoaded: false
        };
        
        const POPULAR_SYMBOLS = [
            { symbol: 'BTCUSDT', base: 'BTC' }, { symbol: 'ETHUSDT', base: 'ETH' },
            { symbol: 'BNBUSDT', base: 'BNB' }, { symbol: 'SOLUSDT', base: 'SOL' },
            { symbol: 'XRPUSDT', base: 'XRP' }, { symbol: 'ADAUSDT', base: 'ADA' },
            { symbol: 'DOGEUSDT', base: 'DOGE' }, { symbol: 'MATICUSDT', base: 'MATIC' },
            { symbol: 'DOTUSDT', base: 'DOT' }, { symbol: 'AVAXUSDT', base: 'AVAX' }
        ];
        
        // API
        class API {
            static async fetchSymbols() {
                const res = await fetch('https://api.binance.com/api/v3/exchangeInfo');
                const data = await res.json();
                return data.symbols
                    .filter(s => s.status === 'TRADING' && s.quoteAsset === 'USDT')
                    .map(s => ({ symbol: s.symbol, base: s.baseAsset }));
            }
            
            static async fetchOHLCV(symbol, interval, limit = 500) {
                const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
                const res = await fetch(url);
                const data = await res.json();
                return data.map(c => ({
                    time: c[0] / 1000,
                    open: parseFloat(c[1]),
                    high: parseFloat(c[2]),
                    low: parseFloat(c[3]),
                    close: parseFloat(c[4]),
                    volume: parseFloat(c[5])
                }));
            }
            
            static async fetch24h() {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
                return await res.json();
            }
            
            static mapTF(tf) {
                const map = { '1': '1m', '3': '3m', '5': '5m', '15': '15m', '30': '30m', '60': '1h', '240': '4h', 'D': '1d', 'W': '1w', 'M': '1M' };
                return map[tf] || '1d';
            }
        }
        
        // Indicators
        class Indicators {
            static SMA(d, p) {
                const r = [];
                for (let i = 0; i < d.length; i++) {
                    if (i < p - 1) r.push(null);
                    else r.push(d.slice(i - p + 1, i + 1).reduce((a, b) => a + b, 0) / p);
                }
                return r;
            }
            
            static EMA(d, p) {
                const k = 2 / (p + 1);
                const r = [d[0]];
                for (let i = 1; i < d.length; i++) r.push(d[i] * k + r[i - 1] * (1 - k));
                return r;
            }
            
            static RSI(d, p = 14) {
                const ch = d.slice(1).map((v, i) => v - d[i]);
                const r = [null];
                for (let i = p - 1; i < ch.length; i++) {
                    const g = [], lo = [];
                    for (let j = i - p + 1; j <= i; j++) {
                        if (ch[j] > 0) g.push(ch[j]);
                        else lo.push(Math.abs(ch[j]));
                    }
                    const ag = g.length > 0 ? g.reduce((a, b) => a + b, 0) / p : 0;
                    const al = lo.length > 0 ? lo.reduce((a, b) => a + b, 0) / p : 0;
                    r.push(al === 0 ? 100 : 100 - (100 / (1 + ag / al)));
                }
                while (r.length < d.length) r.unshift(null);
                return r;
            }
            
            static MACD(d) {
                const e12 = this.EMA(d, 12);
                const e26 = this.EMA(d, 26);
                const macd = e12.map((v, i) => v - e26[i]);
                const sig = this.EMA(macd.filter(v => v !== null), 9);
                const hist = macd.slice(-sig.length).map((v, i) => v - sig[i]);
                return { macd, sig, hist };
            }
            
            static BB(d, p = 20, m = 2) {
                const sma = this.SMA(d, p);
                const u = [], lo = [];
                for (let i = 0; i < d.length; i++) {
                    if (i < p - 1) { u.push(null); lo.push(null); }
                    else {
                        const sl = d.slice(i - p + 1, i + 1);
                        const mean = sma[i];
                        const std = Math.sqrt(sl.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / p);
                        u.push(mean + m * std);
                        lo.push(mean - m * std);
                    }
                }
                return { upper: u, mid: sma, lower: lo };
            }
            
            static calc(data) {
                const c = data.map(d => d.close);
                return {
                    sma20: this.SMA(c, 20),
                    sma50: this.SMA(c, 50),
                    sma200: this.SMA(c, 200),
                    ema12: this.EMA(c, 12),
                    ema26: this.EMA(c, 26),
                    rsi: this.RSI(c, 14),
                    macd: this.MACD(c),
                    bb: this.BB(c, 20, 2)
                };
            }
        }
        
        // AI Analyst
        class AI {
            static analyze(data, ind) {
                const c = data.map(d => d.close);
                const idx = c.length - 1;
                const cur = c[idx];
                const sigs = {};
                
                // RSI
                const rsi = ind.rsi[idx];
                if (rsi < 30) sigs.rsi = { sig: 'strong-buy', val: rsi, reason: 'Oversold', w: 2 };
                else if (rsi > 70) sigs.rsi = { sig: 'strong-sell', val: rsi, reason: 'Overbought', w: 2 };
                else if (rsi < 45) sigs.rsi = { sig: 'buy', val: rsi, reason: 'Bullish', w: 1 };
                else if (rsi > 55) sigs.rsi = { sig: 'sell', val: rsi, reason: 'Bearish', w: 1 };
                else sigs.rsi = { sig: 'neutral', val: rsi, reason: 'Neutral', w: 0.5 };
                
                // MACD
                const macd = ind.macd.hist[ind.macd.hist.length - 1];
                const pmacd = ind.macd.hist[ind.macd.hist.length - 2];
                if (macd > 0 && pmacd <= 0) sigs.macd = { sig: 'strong-buy', reason: 'Bull cross', w: 2 };
                else if (macd < 0 && pmacd >= 0) sigs.macd = { sig: 'strong-sell', reason: 'Bear cross', w: 2 };
                else if (macd > 0) sigs.macd = { sig: 'buy', reason: 'Positive', w: 1 };
                else sigs.macd = { sig: 'sell', reason: 'Negative', w: 1 };
                
                // MA
                const sma50 = ind.sma50[idx];
                const sma200 = ind.sma200[idx];
                if (cur > sma50 && sma50 > sma200) sigs.ma = { sig: 'strong-buy', reason: 'Golden', w: 2 };
                else if (cur < sma50 && sma50 < sma200) sigs.ma = { sig: 'strong-sell', reason: 'Death', w: 2 };
                else sigs.ma = { sig: 'neutral', reason: 'Mixed', w: 0.5 };
                
                // BB
                const bbu = ind.bb.upper[idx];
                const bbl = ind.bb.lower[idx];
                if (cur < bbl) sigs.bb = { sig: 'buy', reason: 'Below lower', w: 1.5 };
                else if (cur > bbu) sigs.bb = { sig: 'sell', reason: 'Above upper', w: 1.5 };
                else sigs.bb = { sig: 'neutral', reason: 'In range', w: 0.5 };
                
                // Calculate score
                let tot = 0, totW = 0;
                Object.values(sigs).forEach(s => {
                    const w = s.w || 1;
                    let sc = 0;
                    if (s.sig === 'strong-buy') sc = 2;
                    else if (s.sig === 'buy') sc = 1;
                    else if (s.sig === 'sell') sc = -1;
                    else if (s.sig === 'strong-sell') sc = -2;
                    tot += sc * w;
                    totW += w;
                });
                const score = tot / totW;
                
                // Determine signal
                let sig, conf;
                if (score > 0.8) {
                    sig = 'STRONG BUY';
                    conf = Math.min(90, 60 + Math.abs(score) * 30);
                } else if (score > 0.3) {
                    sig = 'BUY';
                    conf = Math.min(80, 50 + Math.abs(score) * 30);
                } else if (score > -0.3) {
                    sig = 'HOLD';
                    conf = 60;
                } else if (score > -0.8) {
                    sig = 'SELL';
                    conf = Math.min(80, 50 + Math.abs(score) * 30);
                } else {
                    sig = 'STRONG SELL';
                    conf = Math.min(90, 60 + Math.abs(score) * 30);
                }
                
                return { sig, conf: conf.toFixed(1), sigs };
            }
        }
        
        // UI
        class UI {
            static initChart() {
                const cont = document.getElementById('chartElement');
                APP.chart = LightweightCharts.createChart(cont, {
                    layout: { background: { color: 'transparent' }, textColor: '#94a3b8' },
                    grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                    timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true },
                    height: cont.offsetHeight,
                    width: cont.offsetWidth
                });
                
                APP.candleSeries = APP.chart.addCandlestickSeries({
                    upColor: '#10b981', downColor: '#ef4444',
                    borderVisible: false,
                    wickUpColor: '#10b981', wickDownColor: '#ef4444'
                });
                
                APP.volumeSeries = APP.chart.addHistogramSeries({
                    color: '#3b82f6', priceFormat: { type: 'volume' },
                    priceScaleId: '', scaleMargins: { top: 0.85, bottom: 0 }
                });
                
                const resizeObs = new ResizeObserver(() => {
                    APP.chart.applyOptions({ width: cont.offsetWidth, height: cont.offsetHeight });
                });
                resizeObs.observe(cont);
            }
            
            static loading(show, txt = '') {
                document.getElementById('loadingOverlay').classList.toggle('active', show);
                if (txt) document.getElementById('loadingText').textContent = txt;
            }
            
            static notify(title, msg) {
                const n = document.createElement('div');
                n.className = 'notification';
                n.innerHTML = `<div class="notif-title">${title}</div><div class="notif-body">${msg}</div>`;
                document.getElementById('notificationArea').appendChild(n);
                setTimeout(() => n.classList.add('show'), 100);
                setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 400); }, 4000);
            }
            
            static updatePrice(data) {
                const last = data[data.length - 1];
                const prev = data[data.length - 2];
                const chg = ((last.close - prev.close) / prev.close) * 100;
                document.getElementById('currentPrice').textContent = `$${last.close.toFixed(2)}`;
                document.getElementById('priceChange').textContent = `${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%`;
                document.getElementById('priceChange').className = `price-change ${chg >= 0 ? 'up' : 'down'}`;
            }
            
            static updateSignal(ana) {
                const map = {
                    'STRONG BUY': { cls: 'signal-strong-buy', em: '🚀' },
                    'BUY': { cls: 'signal-buy', em: '📈' },
                    'HOLD': { cls: 'signal-hold', em: '⏸️' },
                    'SELL': { cls: 'signal-sell', em: '📉' },
                    'STRONG SELL': { cls: 'signal-strong-sell', em: '⚠️' }
                };
                const inf = map[ana.sig];
                document.getElementById('signalBadge').className = `signal-badge ${inf.cls}`;
                document.getElementById('signalEmoji').textContent = inf.em;
                document.getElementById('signalText').textContent = ana.sig;
                document.getElementById('confidenceText').textContent = `${ana.conf}%`;
                document.getElementById('confidenceFill').style.width = `${ana.conf}%`;
            }
            
            static updateIndicators(sigs) {
                const html = Object.entries(sigs).map(([n, d]) => {
                    const tc = d.sig.includes('buy') ? 'bullish' : d.sig.includes('sell') ? 'bearish' : 'neutral';
                    const bc = d.sig.includes('buy') ? 'badge-buy' : d.sig.includes('sell') ? 'badge-sell' : 'badge-neutral';
                    return `
                        <div class="indicator-item ${tc}">
                            <div class="indicator-header">
                                <span class="indicator-name">${n.toUpperCase()}</span>
                                <span class="indicator-badge ${bc}">${d.sig.toUpperCase()}</span>
                            </div>
                            <div class="indicator-value">${d.reason}${d.val !== undefined ? ` (${d.val.toFixed(2)})` : ''}</div>
                        </div>
                    `;
                }).join('');
                document.getElementById('indicatorsList').innerHTML = html;
            }
            
            static updateMetrics(data) {
                const c = data.map(d => d.close);
                const chg = ((c[c.length - 1] - c[0]) / c[0]) * 100;
                const hi = Math.max(...c);
                const lo = Math.min(...c);
                const html = `
                    <div class="metric-box">
                        <div class="metric-label">Return</div>
                        <div class="metric-value" style="color:${chg >= 0 ? '#10b981' : '#ef4444'}">${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">High</div>
                        <div class="metric-value">$${hi.toFixed(2)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Low</div>
                        <div class="metric-value">$${lo.toFixed(2)}</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Range</div>
                        <div class="metric-value">${((hi - lo) / lo * 100).toFixed(2)}%</div>
                    </div>
                `;
                document.getElementById('metricsGrid').innerHTML = html;
            }
            
            static async loadMarkets() {
                try {
                    const ticks = await API.fetch24h();
                    const top = ticks.filter(t => t.symbol.endsWith('USDT')).slice(0, 10);
                    const html = top.map(t => {
                        const chg = parseFloat(t.priceChangePercent);
                        return `
                            <div class="market-item" data-symbol="${t.symbol}">
                                <div class="market-header">
                                    <div>
                                        <div class="market-symbol">${t.symbol.replace('USDT', '')}</div>
                                        <div class="market-price">$${parseFloat(t.lastPrice).toFixed(2)}</div>
                                    </div>
                                    <div class="market-change" style="background:${chg >= 0 ? 'rgba(16,185,129,0.2)' : 'rgba(239,68,68,0.2)'};color:${chg >= 0 ? '#10b981' : '#ef4444'}">
                                        ${chg >= 0 ? '+' : ''}${chg.toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('marketsList').innerHTML = html;
                    document.querySelectorAll('.market-item').forEach(el => {
                        el.addEventListener('click', () => {
                            APP.symbol = el.dataset.symbol;
                            loadData(APP.symbol, APP.timeframe);
                        });
                    });
                } catch (e) {
                    console.error('Markets error:', e);
                }
            }
        }
        
        // Main
        async function loadData(sym, tf) {
            try {
                UI.loading(true, 'Loading data...');
                const iv = API.mapTF(tf);
                const data = await API.fetchOHLCV(sym, iv, 500);
                APP.data = data;
                
                APP.candleSeries.setData(data);
                APP.volumeSeries.setData(data.map(d => ({
                    time: d.time,
                    value: d.volume,
                    color: d.close > d.open ? 'rgba(16,185,129,0.5)' : 'rgba(239,68,68,0.5)'
                })));
                
                UI.updatePrice(data);
                
                UI.loading(true, 'Analyzing...');
                const ind = Indicators.calc(data);
                APP.indicators = ind;
                
                const ana = AI.analyze(data, ind);
                UI.updateSignal(ana);
                UI.updateIndicators(ana.sigs);
                UI.updateMetrics(data);
                
                UI.loading(false);
                UI.notify('✅ Complete', `${sym} analyzed`);
            } catch (e) {
                console.error(e);
                UI.loading(false);
                UI.notify('❌ Error', e.message);
            }
        }
        
        // Events
        let searchTO;
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            clearTimeout(searchTO);
            const q = e.target.value.toUpperCase();
            if (q.length < 1) {
                document.getElementById('searchResults').classList.remove('active');
                return;
            }
            document.getElementById('searchResults').innerHTML = '<div style="padding:20px;text-align:center;color:#94a3b8;">Searching...</div>';
            document.getElementById('searchResults').classList.add('active');
            searchTO = setTimeout(async () => {
                try {
                    if (!APP.symbolsLoaded) {
                        try {
                            APP.allSymbols = await API.fetchSymbols();
                            APP.symbolsLoaded = true;
                        } catch {
                            APP.allSymbols = POPULAR_SYMBOLS;
                            APP.symbolsLoaded = true;
                        }
                    }
                    const res = APP.allSymbols.filter(s => s.base.includes(q) || s.symbol.includes(q)).slice(0, 20);
                    if (res.length === 0) {
                        document.getElementById('searchResults').innerHTML = '<div style="padding:20px;text-align:center;color:#94a3b8;">No results</div>';
                        return;
                    }
                    const html = res.map(s => `
                        <div class="search-item" data-symbol="${s.symbol}">
                            <strong style="font-size:14px;">${s.base}</strong><span style="color:#6B7280;">/USDT</span>
                        </div>
                    `).join('');
                    document.getElementById('searchResults').innerHTML = html;
                    document.querySelectorAll('.search-item').forEach(el => {
                        el.addEventListener('click', () => {
                            APP.symbol = el.dataset.symbol;
                            document.getElementById('searchInput').value = el.dataset.symbol;
                            document.getElementById('searchResults').classList.remove('active');
                            loadData(APP.symbol, APP.timeframe);
                        });
                    });
                } catch (e) {
                    document.getElementById('searchResults').innerHTML = '<div style="padding:20px;text-align:center;color:#ef4444;">Error</div>';
                }
            }, 300);
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                document.getElementById('searchResults').classList.remove('active');
            }
        });
        
        document.querySelectorAll('.tf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                APP.timeframe = btn.dataset.tf;
                loadData(APP.symbol, APP.timeframe);
            });
        });
        
        document.querySelectorAll('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                const parent = btn.closest('.card');
                parent.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
                parent.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tab}Tab`).classList.add('active');
            });
        });
        
        // Init
        window.addEventListener('DOMContentLoaded', () => {
            console.log('%c⚡ QUANTUM TERMINAL', 'color:#3b82f6;font-size:20px;font-weight:bold;');
            UI.initChart();
            UI.loadMarkets();
            
            API.fetchSymbols()
                .then(s => { APP.allSymbols = s; APP.symbolsLoaded = true; })
                .catch(() => { APP.allSymbols = POPULAR_SYMBOLS; APP.symbolsLoaded = true; });
            
            setTimeout(() => loadData(APP.symbol, APP.timeframe), 500);
        });
    </script>
</body>
</html>
